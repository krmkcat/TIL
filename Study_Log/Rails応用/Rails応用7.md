# 2023.12.3
ブランチも切ったのでさっそく課題の概要を確認。

なるほど。
- アイキャッチ画像横幅用のカラムをモデルに追加
- 記事編集用のフォームを修正
- 記事プレビューおよび公開用のビューを修正

大まかにはこんな感じかな。

アイキャッチ画像はどのモデルで扱ってるんだ？まずそこを確認しなきゃ。

あ〜また知らんやつ出てきた〜。Articleモデルで`has_one_attached: :eye_catch`してる。なお`EyeCatch`というモデルはない。ひょっとすると`Medium`モデルあたりと関係合ったりするのかな？  
`Medium`モデル見てみたらこっちにも`has_one_attached: :attached`という記述あり。  
なにはともあれ`has_one_attached`というアソシエーションについて調べる。

お、どうもActiveStorageなるものに関係しているっぽい。名前だけは聞いたことあるな。[公式ドキュメント](https://railsguides.jp/active_storage_overview.html)読もう。

なんとなくはわかった。クラウドストレージサービスとの橋渡しをしてるんだな。だからアプリ内にはモデルがないんだ。というか`has_one_attached`はいわゆるアソシエーションとはまた別の概念だなたぶん。  
ということは`eye_catch_width`カラムはArticleモデルに追加すればいいな。で、ビューで表示するときは`eye_catch_width`を横幅に指定すると。  
さっきよりもう少し詳しくタスク書き出すとこんな感じか。

- [x] アイキャッチ横幅用のカラムをモデルに追加
- [x] アイキャッチ配置用のカラムをモデルに追加
- [x] Articleモデルの修正
  - [x] enumの追加
  - [x] バリデーションを設定
- [x] AdminArticlesコントローラの修正（ストロングパラメータの追加）
- [x] ロケールの追加
- [x] 記事編集用のフォームを修正
  - [x] アイキャッチ横幅を入力する数値フィールドを追加
  - [x] アイキャッチ配置を選択するラジオボタンを追加
  - [x] エラーメッセージを日本語化
- [x] 記事プレビューおよび公開用のビューを修正
  - [x] 横幅と配置を指定する

よし、まずカラムの追加から始めよう。マイグレーションファイルを生成する。

カラムを追加するときにマイグレーションファイルを生成する方法、完全に忘れてるわ…。絶対また忘れるからあとでちゃんとTILに放り込んでおこう。とりあえず`rails d`してやり直す。

`eyecatch_align`は`null: false`でデフォルト値設定しちゃってOKだろうけど、`eyecatch_width`はどうするべきだ？？

う〜〜〜ん、見本アプリで試してみたところ、横幅を入力せずに更新ボタン押すとエラーになるときとならないときがあるな。ここはちょっとよくわからない。  
空欄のままだと、横幅が700超える画像の場合は勝手に700に縮小されるっぽい。100より小さい画像はもってないから試してないけど、たぶん100に拡大されるんじゃないかな。  
つまり横幅を指定しない場合の挙動としては、
- 横幅100未満：横幅100に拡大
- 横幅100〜700：そのまま
- 横幅700超え：横幅700に縮小

…になるんじゃないかな。ActiveStorageが画像の変形に対応してるからそれでできそう。

というわけでそれを踏まえてテーブル単位での制約をどうするか考えなきゃ。  
`null: false`はなしで、上限と下限を指定しておくか。マイグレーションファイルのオプションの書き方も全然覚えてないな〜。

…と思ったら、テーブル制約には値の最大値や最小値の概念がないっぽい。あれはあくまでActiveRecordのバリデーションなのか。ややこしい…。

マイグレーションOK。モデル、コントローラとフォームを修正する。

バリデーションで数値の最大値と最小値を指定するには`numericality`オプションが使える。  
`numericality: { in(最小値..最大値) }`で最小値と最小値を指定できる。どっちかだけ指定したい場合どうするかは後ほどまた調べよう。

モデルとコントローラの修正ができたので、フォームの修正に移る。見本みたいにボタンで数値を増減できるフォームにするにはどうすればいいんだろう？`as:`でなにか指定するとかかな？もしくは`class`か。

simple_formの機能だったらしい。というかずっとスルーしてたど、simple_formってGemだったのね。モデルと紐づけるとカラムのデータ型から勝手にフィールドのタイプを判断してくれるそうだ。[参考リンク](https://opiyotan.hatenablog.com/entry/gem_simple_form)

お？横幅のフォームはできたっぽいけど、`eyecatch_align`のほう、どっかでタイポしてるかも。

探すの一旦後にしてフォーム作った。ラジオボタンは`f.input_field :カラム名, as: :radio_buttons`でできる。

さっきのはカラム名のタイポじゃなくて、ストロングパラメータの書き方の問題だったみたい。コロンを前じゃなくて後に書いちゃっててシンボルになってなかったのと、どうも`tag_id: []`との記述位置との兼ね合い？も合ったっぽい。`tag_id: []`が途中に来るとダメだったけど、最後にしたらOKになった。ん〜ちょっと原因気になるな。`tag_id: []`だけシンボルじゃないからそれが関係してるかも。

あ、どうもそういうルールらしい。  
[参考記事](https://qiita.com/sayama0402/items/576345a1f7d37571f5a6)

…と思ったら、[こっちの記事](https://pikawaka.com/rails/permit)参考に`{ tag_id: [] }`ってハッシュで書いたら順番関係なくいけた。ひょっとするとカッコがないと誤認識がおこる（どこまでがひとかたまりなのかの判断をRailsが誤る）みたいなことなのかも。
[この記事](https://qiita.com/kymmt90/items/4ce8618ca8f537b2ef7e)にあるように、
>Hashを許可したかったら配列を、配列を許可したかったらHashを渡せ

…って覚えるのがいいかも。

さて話がそれた。横幅の欄を入力せずに更新ボタン押したら「数値を入力しろ」ってエラーがでたので、バリデーションに`allow_blank`（[Railsガイド](https://railsguides.jp/active_record_validations.html#allow-blank)）を追加した。これなんでこんなことする必要あるんだろう？別にNOT NULL制約付けてるわけでもないのに。

あ〜そうか範囲指定してるからか。100〜700の間でな、って。だからわざわざ「ただし空欄はOK判定な」って押しせてやらなきゃいけないんだ。`description`に`allow_blank`があるのも同じ理由だな。字数制限付けてるから「ただし以下略」ってしてるんだ。なるほど〜。

さて、次はエラーメッセージの日本語化。
```
translation missing: ja.activerecord.errors.models.article.attributes.eyecatch_width.in
```
って出てるからこれを頼りにロケールファイルを探そう。

見本とは少し違うけどできた。もし見本通りにしなきゃいけないようならあとで直そう。見本は数値の範囲指定に`in`を使ってないんだなたぶん。

よし、最後にプレビューと公開画面のビューの修正だ。まず対象のビューを探す。

予想通り、プレビューも公開も`view/shared/article.html.slim`だな。

OK、記述箇所は見つけた。あとはどう修正するか。サイズと配置の2つを指定する必要がある。

サイズは`image_tag article.eye_catch.variant(resize_to_fit: ...)`でいけそう。横幅だけ指定する方法を調べよう。

たぶんだけど縦幅のほうを`nil`にすればいいのかな？  
あと、サイズは直接さっきの方法で指定することもできるけど、カスタムバリアントを作るって方法もあるかもと思った。どっちがいいかな。カスタムバリアントのほうがコードはスッキリしそう。

迷うけど、とりあえず`image tag`で直接指定する方法でやってみる。

いちおうできたけど、これだと横幅指定なしの場合に表示されない。そこ解決しようと思うと一定のロジックが必要になってくるので、やっぱりカスタムバリアント作ったほうが良さそう。

まず`image processing`が入ってるかどうか確認。  
→入ってた。

`metadata[:width]`で画像の横幅が取得できるようなので、それ使ってモデルとコントローラにメソッド定義して分岐処理作ってみる。

よし、これでどうだ？

お、たぶんできたっぽい？横幅100pxより小さい画像がないと検証できないな〜。しかたないから作るか？

用意して試してみた。ちゃんとできてる！良かった〜。あとは配置か。

`align`オプションでいけた〜と思ったら、なぜか`align: 'center'`だけ反映されてない！なぜ？

ロボらんてくんに訊いたら、「imgタグのオプションとして`align="〇〇"`と指定するやり方は古いHTMLの仕様だから、CSS使って親要素に`text-align: center;`を指定するとかしたほうがいいよ！」って言われた。なるほど。imgタグのオプションとして指定するのはもうすでに”一部のブラウザではサポートされてる”くらい古いらしい。  
お手本のソース見たらわかりそうだな。見よう。

あ〜わかった。ロボらんてくんの言う通りだ。親要素である`section`タグのクラスが`eye_cache text-right`になってる。(`cache`はスペルミスな気がするけど)ここをいじればいいんだな。

お、前の課題でもあった、Slimでクラス名の中で変数展開したいときどうする問題発生。

よし、前と同じ方法で解決！  
たぶんこれで実装は完了かな？お手本テストコードダウンロードして走らせてみよう。

危ない危ない、リサイズしたバリアントに`processed`つけるの忘れてた。これやらないと毎回新しく作られちゃうんだよねたぶん。  
よし、今度こそテスト！

2種類エラーが出てる。
```
     Failure/Error: if eye_catch.metadata[:width] < 100

     NoMethodError:
       undefined method `[]' for nil:NilClass

             if eye_catch.metadata[:width] < 100
                                  ^^^^^^^^
```
```
     Failure/Error: command ? eye_catch.variant(command).processed : eye_catch

     ActionView::Template::Error:
       ActiveStorage::FileNotFoundError
```
前者の方はひょっとすると`eye_catch`がない場合に処理を分けなきゃいけなかったかなーと推測。後者はちょっとわからん。前者を解決すれば一緒に解決したりする？とりあえず前者に対処してみよう。

前者は対処成功。予想通りだったみたい。
けどもう一個の方は残ったな。まずはスクショ見てみるか。

う〜んエラーメッセージ以上の情報はない感じだなあ。ブラウザで同じことやってみるか。

普通にできちゃうなあ。もしかしてだけど、バリデーションを`in`使ってやったことと関係ある？？  
テストコード確認すれば詳しいことわかるんだけど、それやるとカンニングになっちゃうのがなあ。どーしよ。  
なんでテスト失敗なのかのメッセージが出てないってことは、やや想定外のエラーってことだと思うんだよなあ。  
まあダメ元でバリデーションの書き方とロケール変えてみるか。

`greater_than_or_equal_to`と`less_than_or_equal_to`を使った書き方に変えてみた。こっちだとロケールが標準で用意されててわざわざ作らなくていいんだな。  
よし、テストしてみよう。

ん〜〜だめかあ。これはもうテストコード見るしかないかなあ。

```
# Errno::ENOENT:
#   No such file or directory @ rb_sysopen - /v3_advanced_rails/tmp/storage/0p/l0/0pl03hg9fo44vee63qponuubpgoy
#   /usr/local/bundle/gems/activestorage-7.0.4/lib/active_storage/service/disk_service.rb:144:in `initialize'
```
ってあるな。ちょっと↑のファイル探してみるか。

ん、確かにないな。`tmp/storage/`に`0p`がない。けどこれだけじゃなんもわからん…。  
しゃーないテストコード見るしかないな。

…ん？テストコードの`fill_in`の第1引数なんかおかしくないか？いやでもそこが原因なら「フィールドが見つかりません」みたいなよくあるエラーメッセージになる気がするな。

一旦コンテナ再起動するか。そういえばしてなかった。

再起動しても変わらんかあ。いちおう`fill_in`の引数変えてみるか。

う〜んこれも効果なし。戻しとくか。

マジで何が問題なのかさっぱりだなあ。RSpecのほうの新要素っぽい`fixture`とかいうの見たらなんかわかるかしら。

画像ファイルが格納されてるだけだった…。

あ、エラー再現できた！そうか確かに「まだアイキャッチが設定されてない状態で、アイキャッチの選択とバリデーションに引っかかる横幅を入力して更新ボタン押す」はやってなかった。これか〜。

`article_decorator.rb`の記述が引っかかってる！思わぬ場所で…。

今日はここまで。明日はエラー解消に取り組む。

# 2023.12.4
昨日のエラーから察するに、たぶんデコレーター使ってバリアントの設定するのが正解なんじゃないかな。Rails基礎でユーザーアバターのプレビューつけるのに挑戦したときそんな感じのやり方したような気がする。  
なにはともあれチェック。

さっきのはちょっと違うかも。これたぶん画像がどのタイミングでアップロードされるかの問題と思われる。  
おそらく現状は`article`が`save`されるタイミングでアップロードされるようになってる。で、バリデーションで引っかかって`save`されなかった場合、`eye_catch`が`attach`はされてる（だから`if @article.eye_catch.attached?`が`true`になっちゃう）けど実際のファイルがアップロードされてなくて「ファイルが見つからん」って言われてるのでは。
たしかアップロードタイミング変える方法がRailsガイドに載ってた気がする。探してみよう。

あったーー！[これ](https://railsguides.jp/active_storage_overview.html#%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%AE%E3%83%90%E3%83%AA%E3%83%87%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3)やー！

`direct_upload: true`をつければいいのはわかったけど、`hidden_field`は必要なんだろうか？？とりあえずなしでやってみるか。

ん〜シンプルに`direct_upload: true`を付けても反映されなくて苦戦中。HTMLに変換されたときの表記が`data-...`ってことは、ひょっとしてTurbo関係みたいな書き方すればいいのか？`data: { 〇〇_〇〇: 値　}`的な。試してみよう。

だめだった…。
[こんな記事](https://patorash.hatenablog.com/entry/2020/12/03/190125)見つけたけど、これが正しいやり方なのか？なんかもっとシンプルなのないのかなあ。

[もっと良さげなの](https://qiita.com/yamada_yoshiki/items/bc6e16fc3c00e451992c)見つけた！これやってみる。

 HTMLのコードは思った通りに生成されたんだけど、なぜかエラーが解消されない。やっぱり`hidden_field`が必要なのか？

今日はここまで。明日はsimple_formで`hidden_field`を生成する方法を調べるところから。

# 2023.12.5
宣言通り`hidden_field`を生成する方法を調べる。
…いややっぱり素直にロボらんてくんに`direct_upload`のやり方訊いてみようかな。

原因判明。`admin.js`に`//= require activestorage`を書いてなかったからだ…。ActveStorage使ってるんだから当然かいてあるっしょ！とか思って飛ばしてた。反省。手順はちゃんと1から全部踏まないとダメだね。

ということはこれでテスト通るかな？やってみよう。

通ったーー！よっしゃこれで実装は完了。一旦コミットする。

## RSpec

OK。というわけでテストの作成に移る。ちょっとネタバレ見ちゃったけどそれはしょうがない。  
一つ前のspecに戻そう。

OK。まずはアイキャッチ用の画像ファイルを用意しないと。すでに答え見ちゃったけど、改めてやり方を調べよう。

画像ファイルは`spec/fixtures/images/`下に配置すればいいんだな。ちなみに"fixture"は日本語にすると"器物"だそうだ。なんて抽象的な…。

よし、配置OK。さっそくテストを書き始めるか。

Capybaraでファイル選択フィールドでファイルを選択するには、`attach_file('フィールド名', ファイルのパス)`。ファイルパスは変数に入れちゃおうかな。

まず横幅が小さすぎるパターンを書いてみたので走らせてみる。

よしうまく行った！同じように大きすぎパターンと適正パターンも作ろう。

ラジオボタンを選択するには`choose '選択肢のID'`。

う〜〜ん、画像が表示されているかどうか、および指定した配置に表示されているかどうか、ってどう確認すればいいんだろう。ネタバレ記事がいくつもあるからそれ見れば一発なんだろうけど、もう少し自力で探ってみたい。ロボらんてくんに訊いてみるか。

さすが〜。良いコード教えてくれた。といってもさっき見た記事にもあったやつだけど。以下回答。

>RSpecで画像の表示を確認するには、have_selector や have_css などのマッチャーを使って、画像のタグが存在することや、特定のsrc属性を持つことをチェックできるよ。たとえば、特定のsrc属性を持つimgタグが存在するかどうかを確認には、以下のように書くことができる。
>
>```rb
>expect(page).to have_selector('img[src$="sample-image.jpg"]')
>```
>ここで $= は、指定した属性値で終わる要素を選択するCSSセレクタだ。また、have_css マッチャーを使っても同様のテストができる。
>
>```rb
>expect(page).to have_css('img[src*="sample-image.jpg"]')
>```
>ここで *= は、部分一致する属性値を持つ要素を選択するCSSセレクタだ。これらのマッチャーを使ってテストを書くときには、画像がロードされるまで少し時間がかかることがあるから、Capybara.default_max_wait_time の設定を確認したり、必要に応じて待機時間を調整することも重要だね。

よし、画像が表示されてるかの確認はできるようになった。問題は配置をどう確認するかだな。

`within`を使うのはどうだろう？さっきの「指定の画像が表示されているか」を「`text-〇〇`というセレクタの中で」、と指定する。これで両方いっぺんにテストできないか？やってみよう。

お、いけた。これが正しいかはわからないけど、とりあえずこれでいってみよう。

複数のクラスを持つ要素を取得するにはクラス名をドットでつなげばOKなんだな。おかげでクラス被り問題が解決した。毎度ありがとうロボらんてくん。

よしできたー！もう時間だけどここまできたからにはプルリクしよ。

LGTM〜！今日はここまで。復習は明日やる。

# 2023.12.6
復習開始。  
復習ポイントをとりあえず読んだ。ActiveStorageのテスト時の設定を書くの完全に忘れてたわ。たしかテスト環境ではデフォルトでサービスがDiscになるんだったかな、そのおかげで書かなくてもできちゃったわけか。追記しよ。

…と思ったらあるじゃん！じゃあ復習ポイントでの修正は特になしか。コード全体の見比べに移ろう。

`article/show.html.slim`のHTMLで`section`タグのclass指定してるところは解答例のほうがスマートでいいな。書き換えよう。

画像のサイズ調整ロジック、必要なかったみたい…。というか、正しい仕様がよくわからない…。見本アプリで明らかにサイズオーバーな画像をアイキャッチとして選択して幅を指定せずに更新するとエラーになる。ただしページをリロードするとアップロード成功してる。で、プレビュー押すとまたエラーになる。？？？  
過去の質問とかにないかな。

なかった…。自分の方で試してみるか。解答例と同じにして、サイズオーバーな画像を選択・横幅未入力にしよう。どうなるかな。

実験した結果、「横幅を指定しなければlgサイズ（1024x768以内で最大）、指定すればその横幅になる」が正解っぽい。でもって上位要素である`.articl-content`が`max-width: 800px`で、`img`が`max-width: 100%`だから、そもそも元の画像サイズがどんなに大きくても横幅800px以上にはならない。800pxが上限。だから`eyecatch_width`が指定されていなくても特に問題はない。  
…ってことだと思われる。見本アプリでエラーになる理由はよくわからない。  

そのままでも特にレイアウト崩れたり極端に見づらかったりはしないけど、小さくしたければできるように調節機能を付ける。…っていうことだったんだな。たしかに横長画像ならいいけど縦長画像だと常に横幅マックス表示は微妙だもんな。  
「フルサイズで表示だとでかすぎて困るから表示サイズを規定する」んだと思い込んでたよ…よく考えたら最初にアイキャッチ付けてみたとき、ちゃんと一定の横幅に収まってたもんな…。ちょっと理解力足りてなかった。反省。

とにかくサイズ調整ロジックはいらなかったようなので、解答例どおりに直す。

よしOK。  
そういやダイレクトアップロードのこと何も触れてなかったけどいいのか？ひょっとしてさっきの質問で見たとおりdecoratorのコードから`.processed`消すのが正解なの？マジ？  
ネタバレ記事見てみよう。

[ネタバレ記事1](https://zenn.dev/meimei_kr/articles/50138b90cbdde8)

ん〜、この記事はそうしてるな。`processed`の恩恵受けられなくなるとはあるけど。エラー解消してるときに他にもいくつかネタバレ記事見かけた気がするんだけど見つけられない…。

まあいいや、一応理屈はわかってるわけだし解答例に合わせておこう。

よし。RSpecのほうは細かい違いはあれどだいたい同じだったからあれでいいかな。

コード修正完了したので新要素のまとめに入る。

- [x] ActiveStorage
- [ ] テーブル制約には値の最大値、最小値の概念がない？
- [x] `numericality`バリデーション
- [x] simple_form
- [x] ストロングパラメータの指定の仕方
- [x] `allow_blank`
- [x] `metadata[:width]`
- [x] 画像の配置指定方法
- [ ] simple_formで`data`属性を指定する方法
- [ ] RSpecで画像系のテストをする方法
- [x] `processed`について

こんなもんかな。まずはライトなやつからいくか。

軽めのやつはこれでいいかな。次はActiveStorageいくか。

OK。正直完全には理解できてないけど今はこんなところでいいだろう。次はSimple_form行くか。

今日はここまで。明日もまとめの続き。


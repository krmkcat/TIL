# 2023.12.3
ブランチも切ったのでさっそく課題の概要を確認。

なるほど。
- アイキャッチ画像横幅用のカラムをモデルに追加
- 記事編集用のフォームを修正
- 記事プレビューおよび公開用のビューを修正

大まかにはこんな感じかな。

アイキャッチ画像はどのモデルで扱ってるんだ？まずそこを確認しなきゃ。

あ〜また知らんやつ出てきた〜。Articleモデルで`has_one_attached: :eye_catch`してる。なお`EyeCatch`というモデルはない。ひょっとすると`Medium`モデルあたりと関係合ったりするのかな？  
`Medium`モデル見てみたらこっちにも`has_one_attached: :attached`という記述あり。  
なにはともあれ`has_one_attached`というアソシエーションについて調べる。

お、どうもActiveStorageなるものに関係しているっぽい。名前だけは聞いたことあるな。[公式ドキュメント](https://railsguides.jp/active_storage_overview.html)読もう。

なんとなくはわかった。クラウドストレージサービスとの橋渡しをしてるんだな。だからアプリ内にはモデルがないんだ。`has_one_attached`はいわゆるアソシエーションとはまた別の概念だなたぶん。  
ということは`eye_catch_width`カラムはArticleモデルに追加すればいいな。で、ビューで表示するときは`eye_catch_width`を横幅に指定すると。  
さっきよりもう少し詳しくタスク書き出すとこんな感じか。

- [x] アイキャッチ横幅用のカラムをモデルに追加
- [x] アイキャッチ配置用のカラムをモデルに追加
- [x] Articleモデルの修正
  - [x] enumの追加
  - [x] バリデーションを設定
- [x] AdminArticlesコントローラの修正（ストロングパラメータの追加）
- [x] ロケールの追加
- [ ] 記事編集用のフォームを修正
  - [x] アイキャッチ横幅を入力する数値フィールドを追加
  - [x] アイキャッチ配置を選択するラジオボタンを追加
  - [x] エラーメッセージを日本語化
- [x] 記事プレビューおよび公開用のビューを修正
  - [x] 横幅と配置を指定する

よし、まずカラムの追加から始めよう。マイグレーションファイルを生成する。

カラムを追加するときにマイグレーションファイルを生成する方法、完全に忘れてるわ…。絶対また忘れるからあとでちゃんとTILに放り込んでおこう。とりあえず`rails d`してやり直す。

`eyecatch_align`は`null: false`でデフォルト値設定しちゃってOKだろうけど、`eyecatch_width`はどうするべきだ？？

う〜〜〜ん、見本アプリで試してみたところ、横幅を入力せずに更新ボタン押すとエラーになるときとならないときがあるな。ここはちょっとよくわからない。  
空欄のままだと、横幅が700超える画像の場合は勝手に700に縮小されるっぽい。100より小さい画像はもってないから試してないけど、たぶん100に拡大されるんじゃないかな。  
つまり横幅を指定しない場合の挙動としては、
- 横幅100未満：横幅100に拡大
- 横幅100〜700：そのまま
- 横幅700超え：横幅700に縮小

…になるんじゃないかな。ActiveStorageが画像の変形に対応してるからそれでできそう。

というわけでそれを踏まえてテーブル単位での制約をどうするか考えなきゃ。  
`null: false`はなしで、上限と下限を指定しておくか。マイグレーションファイルのオプションの書き方も全然覚えてないな〜。

…と思ったら、テーブル制約には値の最大値や最小値の概念がないっぽい。あれはあくまでActiveRecordのバリデーションなのか。ややこしい…。

マイグレーションOK。モデル、コントローラとフォームを修正する。

バリデーションで数値の最大値と最小値を指定するには`numericality`オプションが使える。  
`numericality: { in(最小値..最大値) }`で最小値と最小値を指定できる。どっちかだけ指定したい場合どうするかは後ほどまた調べよう。

モデルとコントローラの修正ができたので、フォームの修正に移る。見本みたいにボタンで数値を増減できるフォームにするにはどうすればいいんだろう？`as:`でなにか指定するとかかな？もしくは`class`か。

simple_formの機能だったらしい。というかずっとスルーしてたど、simple_formってGemだったのね。モデルと紐づけるとカラムのデータ型から勝手にフィールドのタイプを判断してくれるそうだ。[参考リンク](https://opiyotan.hatenablog.com/entry/gem_simple_form)

お？横幅のフォームはできたっぽいけど、`eyecatch_align`のほう、どっかでタイポしてるかも。

探すの一旦後にしてフォーム作った。ラジオボタンは`f.input_field :カラム名, as: :radio_buttons`でできる。

さっきのはカラム名のタイポじゃなくて、ストロングパラメータの書き方の問題だったみたい。コロンを前じゃなくて後に書いちゃっててシンボルになってなかったのと、どうも`tag_id: []`との記述位置との兼ね合い？も合ったっぽい。`tag_id: []`が途中に来るとダメだったけど、最後にしたらOKになった。ん〜ちょっと原因気になるな。`tag_id: []`だけシンボルじゃないからそれが関係してるかも。

あ、どうもそういうルールらしい。  
[参考記事](https://qiita.com/sayama0402/items/576345a1f7d37571f5a6)

…と思ったら、[こっちの記事](https://pikawaka.com/rails/permit)参考に`{ tag_id: [] }`ってハッシュで書いたら順番関係なくいけた。ひょっとするとカッコがないと誤認識がおこる（どこまでがひとかたまりなのかの判断をRailsが誤る）みたいなことなのかも。
[この記事](https://qiita.com/kymmt90/items/4ce8618ca8f537b2ef7e)にあるように、
>Hashを許可したかったら配列を、配列を許可したかったらHashを渡せ

…って覚えるのがいいかも。

さて話がそれた。横幅の欄を入力せずに更新ボタン押したら「数値を入力しろ」ってエラーがでたので、バリデーションに`allow_blank`（[Railsガイド](https://railsguides.jp/active_record_validations.html#allow-blank)）を追加した。これなんでこんなことする必要あるんだろう？別にNOT NULL制約付けてるわけでもないのに。

あ〜そうか範囲指定してるからか。100〜700の間でな、って。だからわざわざ「ただし空欄はOK判定な」って押しせてやらなきゃいけないんだ。`description`に`allow_blank`があるのも同じ理由だな。字数制限付けてるから「ただし以下略」ってしてるんだ。なるほど〜。

さて、次はエラーメッセージの日本語化。
```
translation missing: ja.activerecord.errors.models.article.attributes.eyecatch_width.in
```
って出てるからこれを頼りにロケールファイルを探そう。

見本とは少し違うけどできた。もし見本通りにしなきゃいけないようならあとで直そう。見本は数値の範囲指定に`in`を使ってないんだなたぶん。

よし、最後にプレビューと公開画面のビューの修正だ。まず対象のビューを探す。

予想通り、プレビューも公開も`view/shared/article.html.slim`だな。

OK、記述箇所は見つけた。あとはどう修正するか。サイズと配置の2つを指定する必要がある。

サイズは`image_tag article.eye_catch.variant(resize_to_fit: ...)`でいけそう。横幅だけ指定する方法を調べよう。

たぶんだけど縦幅のほうを`nil`にすればいいのかな？  
あと、サイズは直接さっきの方法で指定することもできるけど、カスタムバリアントを作るって方法もあるかもと思った。どっちがいいかな。カスタムバリアントのほうがコードはスッキリしそう。

迷うけど、とりあえず`image tag`で直接指定する方法でやってみる。

いちおうできたけど、これだと横幅指定なしの場合に表示されない。そこ解決しようと思うと一定のロジックが必要になってくるので、やっぱりカスタムバリアント作ったほうが良さそう。

まず`image processing`が入ってるかどうか確認。  
→入ってた。

`metadata[:width]`で画像の横幅が取得できるようなので、それ使ってモデルとコントローラにメソッド定義して分岐処理作ってみる。

よし、これでどうだ？

お、たぶんできたっぽい？横幅100pxより小さい画像がないと検証できないな〜。しかたないから作るか？

用意して試してみた。ちゃんとできてる！良かった〜。あとは配置か。

`align`オプションでいけた〜と思ったら、なぜか`align: 'center'`だけ反映されてない！なぜ？

ロボらんてくんに訊いたら、「imgタグのオプションとして`align="〇〇"`と指定するやり方は古いHTMLの仕様だから、CSS使って親要素に`text-align: center;`を指定するとかしたほうがいいよ！」って言われた。なるほど。imgタグのオプションとして指定するのはもうすでに”一部のブラウザではサポートされてる”くらい古いらしい。  
お手本のソース見たらわかりそうだな。見よう。

あ〜わかった。ロボらんてくんの言う通りだ。親要素である`section`タグのクラスが`eye_cache text-right`になってる。(`cache`はスペルミスな気がするけど)ここをいじればいいんだな。

お、前の課題でもあった、Slimでクラス名の中で変数展開したいときどうする問題発生。

よし、前と同じ方法で解決！  
たぶんこれで実装は完了かな？お手本テストコードダウンロードして走らせてみよう。

危ない危ない、リサイズしたバリアントに`processed`つけるの忘れてた。これやらないと毎回新しく作られちゃうんだよねたぶん。  
よし、今度こそテスト！

2種類エラーが出てる。
```
     Failure/Error: if eye_catch.metadata[:width] < 100

     NoMethodError:
       undefined method `[]' for nil:NilClass

             if eye_catch.metadata[:width] < 100
                                  ^^^^^^^^
```
```
     Failure/Error: command ? eye_catch.variant(command).processed : eye_catch

     ActionView::Template::Error:
       ActiveStorage::FileNotFoundError
```
前者の方はひょっとすると`eye_catch`がない場合に処理を分けなきゃいけなかったかなーと推測。後者はちょっとわからん。前者を解決すれば一緒に解決したりする？とりあえず前者に対処してみよう。

前者は対処成功。予想通りだったみたい。
けどもう一個の方は残ったな。まずはスクショ見てみるか。

う〜んエラーメッセージ以上の情報はない感じだなあ。ブラウザで同じことやってみるか。

普通にできちゃうなあ。もしかしてだけど、バリデーションを`in`使ってやったことと関係ある？？  
テストコード確認すれば詳しいことわかるんだけど、それやるとカンニングになっちゃうのがなあ。どーしよ。  
なんでテスト失敗なのかのメッセージが出てないってことは、やや想定外のエラーってことだと思うんだよなあ。  
まあダメ元でバリデーションの書き方とロケール変えてみるか。

`greater_than_or_equal_to`と`less_than_or_equal_to`を使った書き方に変えてみた。こっちだとロケールが標準で用意されててわざわざ作らなくていいんだな。  
よし、テストしてみよう。

ん〜〜だめかあ。これはもうテストコード見るしかないかなあ。

```
# Errno::ENOENT:
#   No such file or directory @ rb_sysopen - /v3_advanced_rails/tmp/storage/0p/l0/0pl03hg9fo44vee63qponuubpgoy
#   /usr/local/bundle/gems/activestorage-7.0.4/lib/active_storage/service/disk_service.rb:144:in `initialize'
```
ってあるな。ちょっと↑のファイル探してみるか。

ん、確かにないな。`tmp/storage/`に`0p`がない。けどこれだけじゃなんもわからん…。  
しゃーないテストコード見るしかないな。

…ん？テストコードの`fill_in`の第1引数なんかおかしくないか？いやでもそこが原因なら「フィールドが見つかりません」みたいなよくあるエラーメッセージになる気がするな。

一旦コンテナ再起動するか。そういえばしてなかった。

再起動しても変わらんかあ。いちおう`fill_in`の引数変えてみるか。

う〜んこれも効果なし。戻しとくか。

マジで何が問題なのかさっぱりだなあ。RSpecのほうの新要素っぽい`fixture`とかいうの見たらなんかわかるかしら。

画像ファイルが格納されてるだけだった…。

あ、エラー再現できた！そうか確かに「まだアイキャッチが設定されてない状態で、アイキャッチの選択とバリデーションに引っかかる横幅を入力して更新ボタン押す」はやってなかった。これか〜。

`article_decorator.rb`の記述が引っかかってる！思わぬ場所で…。

今日はここまで。明日はエラー解消に取り組む。
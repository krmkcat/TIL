# 2023.12.13
いきなりブランチ名をミスタイプしてしまった。ブランチの名前変更の仕方をTILに投げたので次からはこれを見れば検索せずにすむ。

無事ブランチ名を直したところで今回の課題の概要把握。

faviconはわかるけどog-imageってなに？っていうのと、そもそもその2つを設定してもどこに反映されてるのかわからんっていうのがまず疑問だな。

う〜んSafariでも見てみたけどやっぱりわからないな。faviconってブラウザのタブとかブックマークリストの頭につくあのアイコンのことだと思うんだけど出てない。

調べてみたけどfaviconの意味はやっぱりあってそう。う〜んローカルだと出ないとか？？とりあえず保留にして、og-imageについても調べてみるか。

og-imageとは、Facebook や Twitter などの SNS で記事をシェアしたときに表示される画像。OGP（Open Graph Protocol）の略で、Web サイトのコンテンツを SNS で伝える際に使用される。とのこと。例↓  
参考記事：[OGPとは？OGPの基本からOGP画像のサイズや設定方法を分かりやすく解説](https://www.itra.co.jp/webmedia/what-is-ogp.html)

![OGPの例](image.png)


faviconが表示されてないという謎はあるけど、一旦先に進んでしまおう。

今回の課題の概要
- トップ画像を管理画面から登録・削除できるようにする
  - その際、一度に複数登録できるようにする
  - 削除は個別にできるように
- faviconやog-imageも個別に削除できるようにする（登録は最初からできる状態）
- トップ画像は複数の画像が一定感覚で切り替わるようにする（swiperというJQueryプラグインを使う）

こんな感じだな。  
よし、コードリーディングして諸々確認しながらタスク書き出してみよう。

- [x] トップ画像
  - [x] モデルに`has_many_attached`を追加
  - [x] `swiper`を導入
  - [x] `shared/_header.html.slim`にトップ画像を表示するコードを追加
  - [x] サイト設定編集フォームにフィールドを追加
  - [x] Admin::Sitesコントローラを修正
- [x] faviconとog-image
  - [x] サイト設定編集フォームに削除ボタン追加
  - [x] Admin::Sitesコントローラを修正

とりあえずこんなもんか。他にもあったら後から追加で。

さて早速取り掛かろう。まずは比較的シンプルそうなfaviconとog-imageから。

アップロード済の画像を削除するにはどうしたらいいか考えなきゃいけないな。Railsガイドになんか載ってないかな。

お、やっぱりあった。  
[Railsガイド](https://railsguides.jp/active_storage_overview.html#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B)

画像は削除ボタン押した瞬間に消えてるっぽいな。Rails基礎でやったブックマークの解除みたいな感じで実装すればいいのかな？当時の記録を見てみよう。

TurboStreamの使い方は一応メモってあった。ただ、これも確かに関係してるかもなんだけど、そのまえに「ボタンを押したらこのメソッドが実行される」っていうロジックを組まなきゃいけないんだよね。  
コントローラに通常のCRUD以外のカスタムアクションを作ればいいのか？それって有りなんだろうか。  
あるいはJavascript使うとか？

カスタムアクションはやっぱり望ましくないっぽい。それよりはサブコントローラを作るほうが良さそうだな。  
参考記事：[DHH流のルーティングで得られるメリットと、取り入れる上でのポイント](https://tech.kitchhike.com/entry/2017/03/07/190739)

今日はここまで。明日はアップロード済画像の削除ボタンの仕組みを引き続き考える。

# 2023.12.14
画像の削除ボタンについて引き続き考える。そもそもアップロードのときはどうしてるんだっけ。

フォームから添付ファイルを受け取って保存する場合は`= f.input :eye_catch, as: :file`みたいにアタッチメント名（っていう言い方していいのかはわからないが）を指定することで他の属性と一緒くたに扱えるんだな。  
とりあえずサブコントローラ方式でやってみるか。`rails g controller namespace/コントローラ名`だな。どういう構成にするべきかな？？URLは`.../admin/site/images`みたいにしたい。ということは`rails g controller admin::site/images`でいいのかな。namespaceの入れ子ってこれでいいんだろうか。

ルーティングは`module`を使った書き方にした。参考記事：[【Rails】 ルーティングのnamespace, module, scopeの違い](https://zenn.dev/kanazawa/articles/37e22059af576f)

`rails g controller admin::site/images`なのか`rails g controller admin/site/images`なのか…。まあいいや間違ってたら`rails d`すればいいんだしとにかくやってみよう。

よし、コントローラとルーティングできた。`rails g controller admin/site/images`で良かったみたいだ。早速ボタンを作ってみよう。

ん〜うまく動いてないな。というか指定したURLにデータが飛んでない感じだ。なんでだろ。

今日はここまで。明日は削除ボタンの続きから。

# 2023.12.15
削除ボタンの実装続き。ボタンのリンクが生きてないのはなんでだろう。

あ〜なるほど、`button_to`はフォームを生成してその中にボタンを作るってことになるのか。だからフォームの中では使えないんだ。`link_to`だとできるのかな？

お、できるっぽい！あと今回はTurbo使ってないみたいで、素直に`method: :delete`って書いたほうがうまくいった。Rails7だからって必ずしもTurbo仕様とは限らないんだな。  
パラメータの受け渡しがうまくいってないみたいなのでそこを調べる。

パスの後ろに`(キー: 値, ...)`ってつければいいんだな。参考記事：[【Rails】link_toに任意のパラメータを付与する方法](https://310nae.com/linkto-param/)

よし！あんまりスマートなやり方じゃないかもだけどとりあえずできた！あとは見た目を整えるのと、余裕があればajax化すればいいか。  
見た目は後でまとめてやればいいから、トップ画像の方に移ろう。

今日はここまで。明日はトップ画像の複数登録とスライダー表示に着手する。

# 2023.12.16
今日はトップ画像の諸々に取り組む。まずは複数登録できるようにする。`has_many_attached`について確認しよう。

よし、まずはSiteモデルに`has_many_attached`を設定する。

OK、次にフォームにフィールドを追加する。`has_many_attached`だと自動的に複数選択可能になったりするのかな？やってみよう。

自動的にはならないな。simple_formで複数選択可能なファイルフィールドを生成する方法を調べよう。

別件になるけど気になる記事を発見。削除ボタンってこんな作り方もできるの？この記事ではActiveStorage使ってないみたいだからちょっと事情が異なるかもしれないけど、いちおうメモっとこう。参考記事：[CarrierWaveとSimpleFormを使ってネストした複数ファイルを登録する](https://qiita.com/takamicii/items/44f4019a059eefc31f65)

ネタバレ記事っぽいけど見つけた。`input_html: { multiple: true }`でいけそうだ。試す。

お、複数選択はできるようになった。ただ表示のコードがきちんとできてないから正しく登録されてるかどうかわからんな。

まずfavicon等に倣ってデコレーターを設定しよう。  
…と思ったけどそう単純じゃないか。複数の添付ファイルを一つずつ取り出したい場合はどうすればいいんだろう？`@site.main_images`ってどういう形式のオブジェクトになってるんだ？配列？ハッシュ？

コンソールで見てみたのが以下。う〜んいまいちわからん。
```shell
[5] pry(main)> site.main_images
=> #<ActiveStorage::Attached::Many:0x0000ffff9f7a4820
 @name="main_images",
 @record=
  #<Site:0x0000ffff9f811808
   id: 1,
   name: "これがサイト名",
   subtitle: "これがサブタイトル",
   description: "これが概要",
   created_at: Sat, 11 Nov 2023 15:20:44.000000000 JST +09:00,
   updated_at: Fri, 15 Dec 2023 21:46:27.000000000 JST +09:00>>
```

DBに保存済のfaviconのほうで`blob`を見てみた。こっちは個別の情報が格納されてるっぽい。
```shell
[3] pry(main)> site.favicon.blob
  ActiveStorage::Attachment Load (1.8ms)  SELECT `active_storage_attachments`.* FROM `active_storage_attachments` WHERE `active_storage_attachments`.`record_id` = 1 AND `active_storage_attachments`.`record_type` = 'Site' AND `active_storage_attachments`.`name` = 'favicon' LIMIT 1
  ActiveStorage::Blob Load (0.4ms)  SELECT `active_storage_blobs`.* FROM `active_storage_blobs` WHERE `active_storage_blobs`.`id` = 9 LIMIT 1
=> #<ActiveStorage::Blob:0x0000ffff8262c410
 id: 9,
 key: "t9lxuanf7iukovzm9lh4e6nnqclq",
 filename: "my_icon.png",
 content_type: "image/png",
 metadata: {"identified"=>true, "width"=>800, "height"=>800, "analyzed"=>true},
 byte_size: 589264,
 checksum: "eGvb1KJXmFxP0EE7rXTmRQ==",
 created_at: Sat, 16 Dec 2023 11:56:36.000000000 JST +09:00,
 service_name: "local">
```

あそっか、まだストロングパラメータの追加してないわ。そりゃデータ飛ばないね。

お、追加したらちゃんと飛んだ。サムネイル表示のところはエラーになってるけど（そりゃそうだ）、`@site.main_images[n]`で個別のファイルを取得できるっぽいことがわかった。これなら`each`でいけそう。削除ボタンは一旦飛ばして表示だけやってみよう。

`each`文のところがエラーになってるな。`main_images`はやっぱり配列じゃないのか？

と思ったらブラウザリロードしたら表示された！なんだよもー。  
とにかく次は個別削除リンクを作る。ボタンにするのはまた後でまとめてやる。

よし、書いたのでやってみる。

できたー！よっしゃ画像の登録・削除については機能自体の実装はOK。あとは見た目だけど、これは最後にまわしちゃえ。いよいよ本題の`swiper`に突入する。

まずは公式ドキュメントをざっと確認しよう。

導入するにあたってNPMとCDNどっちを使うかの2択らしいけど、そもそもNPMとCDNってなんだっけ…。見た感じNPMは実際にファイルをインストールするかたちで、CDNはURL経由で読み込んでるっぽい？

調べてみたけどだいたいそんな認識であってるっぽいな。  
参考記事：[npmとCDNの違い](https://zenn.dev/goldsaya/articles/0317b3c6a8723a)  
今回の場合はどっちのほうがいいとかあるんだろうか？見本アプリ見てみればわかるか。CDNだったらソースに載ってくるもんな。

載ってないな。どいうことはNPMで導入してるのか。じゃあそれに倣おう。

よし、ひととおり目は通したので取り掛かろう。

…と思ったらコンテナ内で`npm install swiper`しても`npm`なんてコマンドないよって言われる。Node.jsが入ってないってことか？じゃあ`yarn`のほうならできるんだろうか。やってみるか。そっちもだめならCDNで。ちょっとDocker関連のファイル覗いた感じ`yarn`使ってそうなんだよな〜。

おし、読み通り！無事`yarn`でできた。  
で、importの設定はどこに書けばいいのかな？Javascript、assetのほうとJavascriptsのほうと2つに分散してるんだよね。

見た感じ`app/assets/javascripts/admin.js`のほうっぽいか？バージョンの違いとかのせいか、けっこう読み込みの仕方が記事によって違って？？？ってなるな。

いちおう読み込み設定やるだけやってみたけどまるで自信ないな。とにかく一度ビューも修正してみて、うまくいかなければそこから考えよう。

ん〜〜だめだ〜〜。エラーはなくなったけどぜんぜん動かない。Javascriptがうまくいってない気がする。やっぱり見本通りにしてもだめってのがキツイなあ。

まずは動かなきゃ意味ないから、スライダーの内容を一旦画像じゃなくて単なるテキストにしておこう。そのほうが見やすい。

一度CDNのほうを試してみるか。そうすれば厄介なアセットの読み込みとか関係ないし。

ええ〜？だめじゃん…

お！？できた！理屈はまったくわからんけど見本アプリと同じように`<header>`の後にJSのコードを入れたらいけた！たぶんスライダーの初期化とかいうのをやってるコードだと思うけど…。さっき作った`swiper.js`とちょっと違うな。だから動かなかったのか？

見本と同じコードで初期化をする、もしくはJSの読み込みをスワイプさせたいものより後に置く、ってことかな？じゃないとスワイプさせたいもののHTML構造が読み込まれる前にswiperが発動しちゃってうまくいかない、みたいな。

「見本と同じコードで初期化」を試してみるか。さっきHTMLにベタで書いたのを消して、`swiper.js`に移植する。

おっとこれはだめみたい。じゃあ今度はJSの読み込みをうしろにずらしてみよう。

これもだめか。ん〜〜全然わからん。わからんけどとりあえずさっきの状態でいこう。なんでそうなるのかは後で確認することにして、とにかく仕様を満たす。

の前に、いちおうさっきの動く状態で`swiper.js`の読み込みやめたらどうなるかためしてみよう。実は要らなかったりする？

要らないんかい！！いやまあ古いやり方なんだろうけど、でも新しいやり方だとできなかったことを考えるとすごく微妙な気持ち。結局何が正解なのかまったくわからん…。ダメ元でロボらんてくんにきいてみるか。

ロボらんてくんの答えもやっぱりいまいちはっきりしないなあ。Webpacker使う前提だし。とにかくやっぱりアセットパイプライン周りがややこしいんだな。  
というか書きながらファイル構成見てて思ったけど、ひょっとして`javascript/application.js`のほうでインポートしなきゃいけなかったりする？assetsのほうじゃなくて。めんどいけどいちおうためしてみるか。

うおおおおできたああ！これか、これが正解だったのか！  
`assets/javascripts/application.js`じゃなくて`javascript/application.js`に公式ドキュメントのとおりに記述。で、続けて同じファイル内にswiperを初期化するコードを記述。

ただこれだとなぜか自動スワイプがされないな。ここはやっぱりベタ書きするなり専用ファイル作るなりして後ろの方で読み込みしないとだめなのかな。

あれ？ベタ書きしてもだめだ。なんでだ？というかベタ書きしたらスワイプすらしなくなっちゃった…。

原因判明。`autoplay`オプションは`autoplay`モジュールをインクルードしてないと使えなかったらしい。普通にデフォルトで行けると思ってた〜。

ともあれこれでようやく仕組みができあがった。次はテキストを画像に入れ替える。  
ただその前にサイズを調整しないと大きすぎ＆バラバラ過ぎで見づらい。というわけでうまいことサイズを調節するための仕組みを作る。

見本アプリ（正確には見本動画だけど）では1200×400に設定されてるな。それでいこう。

スマートなやり方じゃないかもだけどいちおうできた。次はいよいよswiperのテキストを画像に差し替える。

できたにはできた。ただ文字が上にかぶさるんじゃなくて下に表示されちゃってるのが気になる。コードは見本と同じになってると思うんだけどなあ。  
まあいいやこれは一旦ほっとこう。先にサイト設定ページの見た目を整える。

まずは削除リンクの見た目をボタンにする。他のページの削除ボタンがどうなってるか見てみよう。

ユーザーページに「新規作成」があった。classを`btn`にすればとりあえずボタンになると予想。やってみる。

おっとだめだ。じゃあ`btn-primary`をつけたらいけるか？

お、いけた。`btn-〇〇`は必須なんだな。見本に倣って削除ボタンらしい見た目にしたいから、どうすればいいか調べよう。たぶんbootstrapだよね？

見つけた。`btn-danger`が良さそう。

おお〜それっぽい！じゃあ次はこれを画像の横じゃなくて下に出そう。

よし、`br`でいけた。

さて`main_images`はどうしようかな。見本だと1つ1つがすごく小さくて横並びだけど、同じようにできるかな。サイズいくつくらいだろ。

とりあえず300x100にしてみた。サイズはこんなもんで良さそう。  
あとは画像とボタンを一つの`<div>`タグで囲って、それを横並びにするって感じかな。

想定外に難しいな…フォームの一部だからかも？明日はそのへん探ってみよう。今日はここまで。

# 2023.12.17
トップ画像の横並びを引き続きやる。おそらく`<form>`の一部になってることが原因な気がするのでそのあたりを調べよう。

お、`form-inline`ってやつが使えそうかも。

違った…。ま〜じでどうすればいいのかわからん。ロボらんてくんにきいてみるか。

う〜んロボらんてくんでも解決できず。もう諦めてテストすることにする。

テストしたらなんかよくわからん警告が出たのでロボらんてくんに訊いてみる。

なるほど。`has_many_attached`について、Rails7.1からは一律上書き式（7.0まではこれがデフォルト）じゃなくて`.attach`メソッド使って新しいファイルを追加する方式が推奨になるから気をつけろよ、ってことらしい。  
そういやそこの挙動どうするか後で考えようと思って忘れてた。でもテスト通ったってことは上書き式でも課題としては問題ないってことかな。正直アプリの挙動としてはどうかと思うけど。  
ん〜どうしよう。これ修正する？スルーしちゃう？

やるだけやってみるか。めんどそうなら諦めよう。

お、普通にできた。simple_formで隠しフィールド生成するのは`f.input :関連名, as: :hidden, input_html { ... }`でOKみたい。けど`image.sigend_id`ってなんだ？気になる。

どうもハッシュ化されたidかなんかっぽい。これ使って個別削除できるよ！みたいなことがRailsガイドに書いてあるけど、普通のid使うのとなにが違うのかわからん…。

もうちょいちゃんとRailsガイド見てみたら、URLの生成とかに使う推測しづらいidってことっぽい。  
そっかだからURLパラメータに含めて送信するならそっちのほうがいいんだ。ただのidだと色々推測できちゃうもんな。uuidみたいなもんか。

ロボらんてくんにきいたら、その認識で合ってるらしい。直接Blobにアクセスできちゃうと危険だから`signed_id`を使って参照する、って感じか。  
そうとわかれば画像削除のロジック修正したほうがいいな。

いいこと知った。やってみてよかったわ。  
`purge`メソッドは`ActiveStorage::Attached`（`@site.favicon`等）や`ActiveStorage::Attachment`（`@site.main_images`等）だけじゃなく、`ActiveStorage::Blob`（いわゆるBlob）にも使える！

…と思ったらあれー？なんか削除できないんだけどなぜ？？

ん〜〜ロボらんてくんに教えてもらったとおりに修正してもだめだ。こんなとこで時間食うのもあれだし諦めて元通りでいこう。

色々いじっちゃったから一度再テストしよう。

よし無事通った。トップ画像の登録を上書き式から追加式に変更したのでもう一度コミットしとく。

## RSpec
さて機能実装は終わったのでここからはテストの作成に入る。まずはspecフォルダを一つ前の課題のに戻す。

よし。siteのファクトリーから。

できた。続いてsystemスペックを書いていく。  
複数選択可のファイルフィールドで一度に複数のファイルを選択するのはCapybaraだとどうやるんだろう。配列を渡すとかかな？  
検索してもパッと出てこないのでとりあえず配列渡してみよう。…の前にまずはテスト用画像の格納だな。

途中まで書けたから一旦テストと思ったんだけど、どこかで文法ミスってるらしくエラーの嵐。嵐すぎてどんなミスなのかもわからない（見られない）。もう今日は諦めて明日にする。

# 2023.12.19
昨日は時間が取れなかったため1日ぶりに再開。改めてspecコードを見直してみる。

スペースが空いてなかったところがあったので直した。けど、その後JS&CS用サーバー立ち上げようとしたら立ち上がらず。
ということはやっぱりコードの何処かに問題があるということなのでコンテナのログを見る。するとsystemスペックのコードじゃなくファクトリーのほうに問題があることが発覚！  
確認したところ、書き方を完全に間違えていた…。`カラム名 { 値 }`と書くべきところを、`カラム名: { 値 }`とカラム名の後にコロンを入れてしまっていた。まさかのやらかし…。  
でも一つ学んだ。エラーが出た時はコンテナのログも確認するとヒントがあるかもしれない。

というわけで気を取り直してテスト走らせてみる。

ファイルフィールドがどうやっても見つからないって言われてなんでだろうと思ったら、ログインしてなかった…。うっかりミスが多すぎる。

なんかログインできてないと思ったら変数`admin`にコロン付けてた…それがいるのは定義するときだけだ…もういや。

とかなんとか言いつつも無事最初のテストは通った。複数画像の添付は予想通り配列で渡せばよかったみたいだ。引き続き書いていく。

削除ボタンの識別どうしようかな。せっかく自分で設置するんだしid仕込んじゃう？

id仕込んでみた。これでやってみよう。

と思ったけどid必要になるの`main_images`だけか？まあいいやとにかく書いてみよう。要らなければ後で消せばいい。

結局idの仕込み方を変えて無事成功。最初は削除リンクそのものに仕込んでたけど、それだと`whithin`が使えないので、各画像のサムネイルと削除リンクをまとめて`〇〇_container`に入れた。

今日はここまで。明日はテスト完成させて通したい。

# 2023.12.20
テスト作成の続き。

`main_images`の削除テストがうまくいかない。`site.main_images[0]`が`nil`になってるみたい。スクショ見る限り画像自体はちゃんと登録されて表示もされてるみたいなのになぜ？

`binding.pry`で確認してみたら、`site.main_images`自体が空になってるっぽい…なんで？

確認したらちゃんとできてる`favicon`も`id=nil`なんだけど…。ActiveStorage関係は普通にやってもだめってことか？

`fixture_file_upload`ってメソッドがあるのか。これ使わないとアップロードされないとか？（じゃあなんで表示はされるんだよとは思うが）

↑についてロボらんてくんに訊いてみた。以下解答。

>fixture_file_uploadメソッドは、RSpecでテストを書いているときに、ファイルのアップロードをシミュレートするためのヘルパーメソッドだね。このメソッドを使うと、実際にファイルをアップロードしなくても、ファイルがアップロードされたかのような状態を作り出すことができるんだ。
>
>テストでは、実際にファイルをアップロードするのは時間がかかるし、環境によってはファイルを保存する場所がないかもしれない。だからfixture_file_uploadを使って、その場でテスト用のファイルを作り出して、コントローラーやモデルがファイルを扱うロジックをテストするわけだ。
>
>例えば、ユーザーがプロフィール画像をアップロードする機能をテストしたい場合、fixture_file_uploadを使ってダミーの画像ファイルをアップロードしているかのようにして、その後のプロセス（画像の保存や表示など）をテストすることができるんだ。
>
>使い方はこんな感じだよ。
>```
># specフォルダの中にfixturesというフォルダを作って、その中にテスト用のファイルを置く
># 例として、spec/fixturesの中にsample.pngというダミーの画像ファイルを置いたとする
>
># テスト内で以下のように使う
>file = fixture_file_upload('spec/fixtures/sample.png', 'image/png')
>
># これで、fileオブジェクトが画像ファイルのアップロードをシミュレートしたものとして扱える
># 例えば、フォームにファイルが添付されたときのパラメータと同じようにfileを使ってテストを書ける
>```

実際には画像は`fixtures/images/`に入れてるから、そこの設定変更が必要かも。

あった。これで設定できるらしい。
```rb
RSpec.configure do |config|
  config.fixture_path = "spec/以下のパス"
end
```

ん？でも別に`images/`から書けばいいのか。まあいいやさっそくやってみよう。

いや、やっぱり設定いるな。書いてみる。  
…いや、やっぱり新たに`files/`ディレクトリを作ることにする。そのほうが早い。設定変えるのは余裕があったらにしよう。

よし、できた！ブラウザ操作しても擬似アップロードにはどうやらならないんだな。

`site.main_images`が無事`nil`じゃなくなった！これでできるはず。

ん〜、今度は逆にDB上には存在する（擬似アップロードされてる）けどブラウザ上でサムネイルが表示されてないな。サイト設定ページへの訪問処理を"サイト設定の編集"の中から"画像の削除"の中に移動させてみるか。

ええ〜だめかあ。なんでよ…。

ロボらんてくんに相談してみたんだけど、ひょっとしてテスト環境でのActiveStorageの設定をしてないとか？

普通にしてあった…。

`save_and_open_page`とかいう便利メソッドをロボらんてくんが教えてくれた。さっそくチャレンジ。

なんかローカル環境の設定の問題で使えなかった。使うための方法教えてくれてるけど難しくてわからん…。そこまでする気力ないよ。

もーーーだめだ。無理。あきらめてプルリクしてLGTM出てから答え見る。画像の横並びといいこれといい、今回の課題わからんこと多すぎ。嫌になっちゃった…。これ以上はストレス溜まるだけなのでここで諦める。

そういやトップ画像のスライダー表示テストはまだ着手してなかったな。どうしよ、これだけいちおう手出すか？

やるだけやるか…。嫌になったら即諦めよう。

うまくいかない原因わかったーーーー！！！  
Seedで自動的にSite（id=1）がひとつ作られるようになってるにもかかわらず、さらに`let(:site) { create(:site) }`（id=2）してたからだ！  
`attach_file`使ってブラウザ経由で添付したときは、ブラウザ経由だからid=1のほうのSiteに添付された。`@current_site = Site.first`、つまり実際に使われるのは常にid=1のSiteのデータなので、`@site.〇〇.attached?`が`true`となりサムネイルと削除リンクは問題なく表示された。でも画像idの呼び出しはid=2のほうのSiteに対して実行してた（`site（←これはid=2のほう）.〇〇.id`）から「画像なんて添付されてないよ」ってことで`nil`になっちゃった。  
一方`fixture_file_upload`を使ったときはid=2のほうのSiteに画像を添付してしまった（`site.〇〇 = ...`）。さっきも書いた通り`@current_site`はid=1のSite固定なので、`@site.〇〇.attached?`は`false`になってしまい、サムネイルや削除リンクは表示されなかった。ただし画像idの呼び出しや添付されてるかの確認はid=2のSiteに対して実行していた（`site.〇〇.attached?`）ので、できてしまっていた。  
…ってことだ。うわあああ。

いちおう気づいた経緯も残しておく。  
スライダー表示のテストで`site.name`が現在のページ内に含まれるかを確認したら、なかったためエラーになった。スクショを確認したら、なぜかFactoryBotで指定したサイト名（`site.name`）じゃなく、"Blog"になってる。サブタイトルもぜんぜん違う、というかデフォルトのまま。  
え？なんで？そんなことある？と混乱しつつRSpecのログを見てたら、Seedのログに目が留まった。ん？ここで設定されてるサイト名とサブタイトル、さっき表示されてたのと同じじゃない？？  
…とここで気づいてはっとなった。

は〜〜〜〜こんなことで…。しかしスライダー表示のテストまじでやってみて良かった。これやってなかったら絶対気づかないままだった。正直めっちゃやりたくなかったけど、その気持ちに負けずに挑戦して良かった！

よし、そうとわかれば修正。

っしゃまずはスライダー表示のテスト通過！そして今度こそ画像削除のテストに挑む。

よっし！まずはfaviconだけだけど通った！この調子で残りも行くぞ〜。

はい、og_imageもOK！ラストmain_images！

よっしゃーーー！全部通った！これで心置きなくプルリクできる〜。まあ個別削除のロジックは最善手ではなさそうだけど〜。

まずはコミット。

いやったーーー！まさかの一発LGTM！Lintチェックの引っかかりなし！
今日はここまで。明日から復習に入る。

# 2023.12.21
復習開始。まずは復習ポイントをチェック。

Swiperの導入に関しては注意書きに合った通りやり方が古くて残念ながらあんまり参考にならないな。

画像削除はシンプルに`ActiveStorage::Attachment`をid指定して削除すればよかったらしい。確か中間テーブル的なやつだっけ？`ActiveStorage::Attachement`と`ActiveStorage::Attached`と`ActiveStorage::Blob`についてはそれぞれどんなものなのかちゃんと確認しなきゃだな。  
画像削除用のコントローラを作ったのはやっぱり正解だったみたい。コントローラ名は解答例に合わせて直しておこう。

あ〜ポリシー設定は完全に頭から抜けてたわ。これは確かにやったほうがいいやつ。

トップ画像の出し分けも全く考えてなかった。やっとかないと困るねこれも。

トップ画像のバリデーションもかけてないわ…今回手落ち多いな。

復習ポイントの中で直す必要があるのはこのくらいか。

- [x] 画像削除ロジックの修正
- [x] 画像削除用コントローラの名前変更
- [x] Siteのポリシー設定
- [x] トップ画像の出し分けロジック追加
- [x] トップ画像のバリデーション追加

まずはコントローラの名前変更するか。

次に画像削除ロジックの修正。今はとりあえず解答例通りに直すだけにする。なんでそうなるのかは後で調べる。

`link_to`の引数、`..._path(ここにid)`って書き方ありなんだな。パラメータ名を指定しないと自動的に`id`とみなされるってことなんだろうか。
→やってみたけど違うみたい。どういうことだ？

いまいちわからんので後にしてSiteのポリシー設定。

次、トップ画像のバリデーション追加。  
あ〜前に何処かでやりかけて結局必要ないことに気づいたのでやらなかったカスタムバリデーター、ここできたか。これも後でちゃんと把握するとして、今はとりあえず写経しとくか。  

全然意味わからんけど一旦よし。最後、トップ画像の出し分けロジック。

Applicationコントローラで`helper_method :current_site`ってしてるから"@"なしで`current_site`でいいのか？これも要確認。

よし、復習ポイント内の修正はOK。今度は解答例のコードを見て直すところ探していく。

トップ画像の横並びどうやってんのかと思ったら普通にCSSベタ打ちかい！削除ボタンには有効だったBootstrapがなんで適用されなかったのかはわからないけど、とりあえず写経。

CSSというかSCSSか。知らない書き方だ。これも基本的な文法くらいは把握しといたほうがいいのかなあ。ビューの方もこれに合わせて`.main_images_box`に書き換えないといけないな。あ、でもそうするとテストも書き換え必要？めんどいなあ。まあそこはテストコードも確認しなきゃだからあとにするか。

ヘッダーの方もベタ書きしてる…。これもまずは写経だな。

削除ボタン、テストのときはどうやって個体識別してるんだろ。まだテストコードまでたどり着いてないから気になってしょうがない。  
あと隠しフィールドつかってないなこれ。ないと都度上書き式になるはずだけど、それでOKってことか？まあそこは指定なかったからその可能性もあるなとは思ったけど、あの手間は何だったのか…。仕方がない、解答例に合わせて消しておこう。

Swiper関係の正解がま〜じでわからん…。こういうのこそ技術面談で訊いたほうがいいんだろうか。

お、テストコードきた。どうなってるんだろ。

なんか新しい%記法出てきた。`%w`ってなんだろう。
→半角スペース区切りで配列を作れるらしい。

なんだよ〜普通に1つだけ画像アップしてそれを消してるだけじゃん！複数あるトップ画像のうち特定のものだけを消すとかやってないじゃん！それでよかったんかい…。あの苦労は一体…。  
しかもよく見ると画像削除の判定、`<img>`タグの値後方一致でやってる。これじゃ同じ画像をfaviconとog_imageとmain_imagesに登録したケースに対応できんやんけ！  
まあでもそこはテストだからいいってことなのか。テストの判定のためにタグやらidやら付け加えるのはあんま良くないのかもしれないな…。  
テストコードは写経しなくていいや。

よし、これでコード修正は終了。時間もちょうどういいので今日はここまで。明日からわからなかったことを調べたりまとめたりしていく。

# 2023.12.22
まとめに入る。まずは必要項目のリストアップ。

- [x] Swiper
  - [x] 導入方法
  - [x] autoplay
- [x] simple_form
  - [x] 画像フィールドの生成
- [x] 入れ子のルーティング
- [x] `button_to`と`link_to`
- [x] `link_to`にパラメータを付与する方法
- [x] ActiveStorageのオブジェクトについて
  - [x] それぞれの違い
  - [x] `signed_id`
  - [x] `purge`メソッド
- [x] npmとCDN
- [ ] カスタムバリデーター
- [x] `helper_method`
- [x] `%w`
- [x] `url_for`
- [x] RSpec
  - [x] ファイルフィールドで複数のファイルを選択
  - [x] `fixture_file_upload`
  - [x] ファイルパスの設定
  - [x] `save_and_open_page`

盛りだくさん〜。それもよくわかってないから色々調べて理解しなきゃいけないものばっか。今週中に終わるかなこれ。

とにかくライトそうなのから一個ずつ取り組んでこう。まずは`%w`から。

できた。次、simple_form。

OK。もうすでにライトなのが尽きたな…。ActiveStorageいくかあ〜。

`site.favicon`の返り値は`ActiveStorage::Attached::One`。中身は関連名を示す`name`と、どのレコードと紐づいているかを示す`record`。
```
[2] pry(main)> site.favicon
=> #<ActiveStorage::Attached::One:0x0000ffff90a96a60
 @name="favicon",
 @record=
  #<Site:0x0000ffff90b1a888
   id: 1,
   name: "これがサイト名",
   subtitle: "これがサブタイトル",
   description: "これが概要",
   created_at: Sat, 11 Nov 2023 15:20:44.000000000 JST +09:00,
   updated_at: Thu, 21 Dec 2023 21:53:51.000000000 JST +09:00>>
```

`site.main_images`の返り値は`ActiveStorage::Attached::Many`。中身は`...One`と同じ。
```
[3] pry(main)> site.main_images
=> #<ActiveStorage::Attached::Many:0x0000ffff90a69df8
 @name="main_images",
 @record=
  #<Site:0x0000ffff90b1a888
   id: 1,
   name: "これがサイト名",
   subtitle: "これがサブタイトル",
   description: "これが概要",
   created_at: Sat, 11 Nov 2023 15:20:44.000000000 JST +09:00,
   updated_at: Thu, 21 Dec 2023 21:53:51.000000000 JST +09:00>>
```

ActiveStorage::Attachedの役割がどうにもイメージしづらいんだけど、いちおうロボらんてくんがくれた解説が以下。ファイルの実体にアクセスするための窓口ってことなのかな。

>ActiveStorage::Attachedがファイルの実体を直接持っているわけではないけど、Railsが提供するビューヘルパー（この場合はimage_tag）は、そのActiveStorage::Attached::Oneオブジェクトを受け取ると、背後で必要なActiveStorage::BlobやActiveStorage::Attachmentにアクセスして、実ファイルへのURLを生成するんだ。
>
>だから、image_tag @site.faviconと書くと、@site.faviconがActiveStorage::Attached::Oneオブジェクトであることから、そのオブジェクトに紐づいている実ファイルの情報（ActiveStorage::Blob）を探し出して、最終的にはそのファイルのURLをimage_tagが使って画像を表示できるようにしているんだ。これがなぜActiveStorage::Attachedを通じてファイルの実体が扱われるように見える理由だね。実際のところは、ActiveStorage::Attachedがファイルへのインターフェースとして機能しているというわけだ。

「ファイルの実体にアクセスするための窓口（取次係）みたいなイメージ？」って訊いたらそのとおりとのこと。なるほどそう思うと一気にわかりやすくなった。実際の解答は以下。

>その通りだね。ActiveStorage::Attachedは、実際のファイルデータ（ActiveStorage::Blob）とRailsアプリケーション内のモデル（例えばsite）との間に立って情報を取り持つ役割をしている。ユーザーはActiveStorage::Attachedを通じて添付ファイルを扱い、ファイルのアップロードや表示などの操作を行えるようになっているんだ。

今日はここまで。明日は今日わかったことをまとめることから始めよう。

# 2023.12.23
ActiveStorageに関するまとめから再開。

`purge`は結局`Attached`、`Attachement`、`Blob`の全部に対して使えるでいいんだっけ？再度ロボらんてくんにきいてみよう。

いちおう全部に対して使えるけど、Blobに対して使うことは通常ないとのこと。BlobがAttachmentを介して紐づけられていない場合（そんなことあるのか？）は`blob.purge`も可能だと。

今日はここまで。明日も復習の続き。

# 2023.12.24
クリスマスイブだけどそんなの関係ねえ。まとめ続き。個々のメソッド系からいく。

あーなんで`link_to`でidが単体で渡せなかったのかわかった！メンバールーティングになってなかったからだ。`resource`じゃなくて`resources`にしないといけなかったんだ。`link_to 'テキスト', パス(id)`ってできるのはURLパターンにidが含まれる場合だけなんだ。そういうことか〜。

さーそろそろSwiperいくかあ。環境による違いが結構大きいみたいだから、とりあえず今回やったやりかたをメモしておくことにしよう。

SwiperのCSSの読み込み、あれでいいのかずっと不思議だった（CSSのインポートはCSSでしないといけないんじゃないの？と思った）んだけど、どうやら"CSS Modules"というものがあればJSファイル内でCSSをインポートすることができるらしい。おそらくこれかな？  
参考リンク：[似て非なるCSS Module Scripts](https://zenn.dev/akfm/articles/e7615e8e826df8)

ロボらんてくんに訊いたらやっぱりそうらしい。は〜なるほど。だから逆にCSSファイルでインポートしようとするとおかしなことになったのか。  
以下解答。

>JavaScriptでCSSファイルをインポートするのは問題ないよ。それは特にWebpackや他のモジュールバンドラーを使っている場合によく行われる方法だ。WebpackなどはJavaScriptを通じてCSSファイルをインポートし、最終的なバンドルに含めることができるようにしてくれるんだ。だから、そのコードでimport 'swiper/css/bundle';としているのは全く問題ないし、Swiperのスタイルが正しく適用されるはずだ。

よっしゃーあとはカスタムバリデーターとRSpecだけだ〜。内容わかってるRSpecから先やって、その後カスタムバリデーターの解読を試みるとしよう。  
今日はここまで。

# 2023.12.25
RSpecのまとめをやる。

よし終わり！あとはカスタムバリデーターのみ。解読チャレンジ。

んんん〜だめだややこしい…全然わからなくて眠くなっちゃう。ここはロボらんてくんに１行ずつ解説をお願いするか。

文章量が多すぎるのか、回答が全然表示されない…。いつもは少し待つと出てくるんだけど。明日になっても出てくるかどうかって感じだな。

`ActiveStorage Validations`というGemがあるみたい。これ使うとわざわざカスタムバリデーター作らなくてもありがちなバリーションが使えるんだな。こっちのほうが楽そう。

だめだー眠い！わからない！もう一旦スルーしよう…また必要になったら詳しいやり方を調べることにする。

というわけで復習おしまい。次に進むか他のことするかは明日決めよう。
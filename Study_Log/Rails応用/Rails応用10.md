# 2024.1.5
Rails応用ラスト。まずはブランチ切る。

OK。続いて課題の概要把握。

メール送信の仕方全く覚えてないのでまずその復習からだな…。TILにまとめたはずだから見直そう。  
…と思ったらこれRails基礎の内容か。じゃあTILにはないな。Notionを見るしかないか。あんまりちゃんとまとめてない気がするなあ。

あれ、Notionでもない。ということはZennかなー。一回学習ログちゃんと一箇所にまとめないとだ。

ええ〜Zennにもない！ひょっとしてどこにも記録残してないのか？？マジか〜。

結局Notionにあった！お試しログ駆動置き場のほうだった。これのメール機能周りを読み直そう。

読み直した。あんまり細かいことは記録してないけど、参考にしたリンクはちゃんと貼ってあったのでこれ見ればなんとかなりそうだ。

とりあえず大まかにやることとしては、

- メール機能の実装
- 記事数集計のロジックを実装
- 定期実行タスクを設定

この3つかな。まずはメールを送れるようにして、その後定期実行タスクを設定、最後に記事数集計ロジックを作ってメール本文を動的に生成できるようにするか。

すっかり忘れていたIssueを久々に書いてみた。これを元に進めていく。

まずはGemのインストール。letter_opener_webとconfigを入れる。  
…と思ったら両方入ってた。じゃあメーラーの作成から行くか。

`rails g mailer メーラー名UCC メソッド名` でメーラー生成できる。なので今回の場合は、`rails g mailer ArticleMailer report_summary`かな。さっそくやってみよう。

よし、生成できた。

メーラーの編集とメーラービューの作成もOK。

今日はここまで。明日はletter_opener_webの設定から。

# 2024.1.6
昨日の続き。letter_opener_webの設定から。

ルーティングはもともと追加済だった。設定だけ追記する。

続いてconfig…と思ったけど、ひょっとして今回はこれ以上やることない？ホストの設定必要ないのでは？Rails基礎がどうなってたか確認してみる。

うん、やっぱり。メール本文内でURLを使う場合は設定しとかないといけない（メーラーのインスタンスは、サーバーが受信するHTTPリクエストのコンテキストと無関係なため）けど、そうじゃなければ必要ないっぽい。というわけでスルー。  
一旦ここでコミットしとこう。

さて、次は定期実行タスクの作成と設定。こっちも一連の流れを復習しておこう。

- rakeタスクを作成
- `config.schedule.rb`に作成したタスクを追加
- コマンドを実行してcronにタスクを登録

って感じだな。

とりあえずrakeタスクを書いたのでテストしてみる。

以下のエラーが出た。
```
NameError: undefined local variable or method `report_summary' for main:Object
```

そうか、`ArticleMailer.report_summary.deliver_now`ってしなきゃいけないんだな。

よし！テスト成功。  
プレーンテキスト版だけにしたいんだけど、その場合はHTML版のビューを削除しちゃえばいいのかな？

いいっぽい。  
よし、じゃあここで記事件数を動的に取得するように修正しちゃおう。それができたら最後にタスクを定期実行するようにcronに登録する。

- [RailsのActiveRecordで今日・昨日など特定の日に保存されたレコードを取得](https://easyramble.com/get-today-record-with-rails-activerecord.html)

よし、メーラーとメーラービューを修正したので再度テスト。

たぶん大丈夫そう。"昨日公開された記事"を増やして再度テストする。

よっし！メール内容はこれでOK！送信先アドレスはたぶんベタ打ちでいいんだよね？Userモデルにカラム追加しなくていいってことは。

さてじゃあ定期実行タスクとして登録しよう。

OK！これで課題の要件は満たせたはず。一旦コミットしよう。

あ、しまった。先にテスト通してからにすれば良かった。まあいいや、順番前後しちゃったけどお手本コードでテストしよう。

送信フォーマットが正しくないっていうエラーが出た。どういう意味？？  
とりあえず、プレーンテキスト版のみ送信するように設定してみる。

あ〜わかった！「公開済み」じゃなくて「公開済」にしなきゃいけないんだ！修正してもっかい走らせてみよう。

だめじゃん…。なんでだよ。ロボらんてくんに相談してみよう。

全角コロンじゃなくて"半角コロン+半角スペース"だったらしい。ぜんっっぜん気づかなかった…。これは訊いてみて良かった。機械だからこそ気づけるやつだ。

通ったーー！！もう一度コミットして、それからテストの自作に移ろう。

よし。テスト作成開始。まずはネタバレに気をつけつつRSpecでActionMailerのテストをする方法を調べよう。

- [Rails6のActionMailer機能をRSpecでテストする方法](https://qiita.com/hiroki_tanaka/items/f8c7759682539d7330cd)
- [[RSpec] ActionMailerのメール送信に関するrequests specまとめ](https://ac-creative-lab.net/rspec-test-to-send-mail-with-actionmailer/)

なるほど。まず"メールを送信＆送ったメールの情報を取得"という一連の処理（結果的に中身は送ったメールの情報となる）をテスト対象の変数として用意して、それを使って`expect`を書くって感じだな。  
さっそく書いてみよう。

よし、とりあえずベタ書きでうまくいった。あとはこれを定期自動タスクとして正しく実行されるかというのと、記事件数によって正しく本文が生成されるかをテストすればいいな。まずは定期自動タスクとして正常に動作するかのテストを作るか。記事の自動公開機能のやつを参考にしよう。

よーしできた！テストも通った！のでプルリクする。今回めっちゃすんなり終わったな。

Lintチェックで２つ引っかかった。どっちも不要な空行があるというもの。サクッと直して再度プッシュする。

無事LGTM！このまま復習ポイントのチェックに移る。

## 復習
復習ポイントを見て直したいところは、

- [x] `published_at_yesterday`というスコープを作ってそれを使う
- [x] 条件分岐を`present?`を使った書き方に変える
- [x] インスタンス変数の名前変更
- [x] メーラーレイアウトを一応slimに直しておく

こんなとこかな。早速直していく。

途中で試しに再度テストしたところ、scopeの書き方が引っかかった。プレースホルダー使う必要ないのに使ってたのが原因。普通にキーと値で書いたらOKだった。プレースホルダー使う必要があるのは比較演算子を使うときと、あいまい検索するときだけ。忘れないようにしよう。

今日はここまで。明日は解答例見ながらコード修正していく。

# 2024.1.7
解答例見ながらコード修正する。

`count`というメソッドを初めて知った。単に`count`で配列の要素数を、引数を渡すと要素のうち引数に一致するものの個数を返す。ブロックを渡した場合はブロックを評価して芯になった要素の個数を返す。  
`length`や`size`と何が違うんだ？

ロボらんてくんに訊いてみた。やはり`count`がほかと違うのは引数を渡せる点であって、引数を渡さない場合は基本的には`length`や`size`と同じ結果になるとのこと。  
あともう一つ`count`の特徴として、ActiveRecordで使うとデータベースレベルでの操作になる（データベースに対してCOUNTクエリを発行し、該当するレコードの数を直接カウントする）らしい。

日付関連のメソッドは一度まとめておきたいな。

ホストの設定は今回の場合要らないはずだけど、一応追加しておくか。

rakeタスクのファイル名＆名前も修正。

RSpec。何度も使う`expect`を変数に格納しておいて呼び出すのは便利だな。  
テスト内容は概ね同じっぽいから修正はしなくていいかな。  
`be_truthy`って初めてみたな。たぶん`true`であるって意味なんだろうけど`be_true`と何が違うんだ？一応調べてみるか。

RSpec3から`be_true`と`be_false`が`be_truthy`と`be_falsey`に変わったらしい。"`nil`と`false`以外はなんでも`true`判定"、"`false`だけでなく`nil`も`false`判定"だからそのほうが名称として正確ということらしい。確かに。  
完全に`true`もしくは`false`に一致するか確認したければ、`eq(true)`および`eq(false)`を使えば良い。

よし、修正はこれで終わり。ほんとにあっさりできたな。  
とはいえ結局この後が時間かかるんだよな。諸々まとめ開始。まとめなきゃいけないのは、

- [x] ActionMailer関連
- [x] letter_opener_web関連
- [x] config関連
- [x] ActionMailer周りのテスト方法

こんなとこか。  
まずはActionMailerからいこう。

次、config。

よし。今日はここまで。明日はletter_opener_webからやろうかな。

# 2024.1.8
letter_opener_webのまとめやる。

OK！ラスト、ActionMailer周りのテスト。

できた。復習OK。これにてRails応用完了。お疲れ様でした。
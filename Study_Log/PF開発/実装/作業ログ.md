# 2024.3.2

まずはヘッダーとフッターから行くか。  
今は触らないでおくけど、あとでIssueをIn Progressに移動させるのを忘れないようにしよう。あとプルリク時にIssueにリンクさせるのも。

最初にとにかくブランチを切る！これを忘れないように気をつけなきゃ。

ブランチの命名とか切り分けどうしようと思って色々見てみた。  
main→develop→個々のブランチ、みたいに2回枝分かれするやり方もあるみたいだけど、正直絶対混乱してやらかすと思うからdevelopはなしでいく。mainから直接個々のブランチに枝分かれする方式で。  
で、命名については"`featureとか/個々のブランチ名_#issueナンバー`"でいこう。

あとやっぱり最初は会員登録・ログインから行こうかな。そこと店舗一覧ができてからトップページに移行する。ヘッダー・フッターはもう少し後でいいや。  
というか会員登録とログイン分けたほうが良かったかも。

んん〜〜どうしよう。そのへんのこともあるし、やっぱりレビュー返って来るまで進めないほうがいいか？先にロゴとか作る？

とりあえず仮にロゴ作るか…。

仮ロゴできた。  
まだレビューこないなあ。次はdaisyUIの配色（テーマ）でも作るか？

仮テーマ作ったのでメモっとく。

```js
module.exports = {
    daisyui: {
      themes: [
        {
          mytheme: {
 "primary": "#3F6C45",
 "secondary": "#50312F",
 "accent": "#CB0000",
 "neutral": "#fef9c3",
 "base-100": "#E4EA8C",
 "info": "#2dd4bf",
 "success": "#22c55e",
 "warning": "#fbbf24",
 "error": "#f43f5e",
          },
        },
      ],
    },
    plugins: [
      require('daisyui'),
    ],
    //...
  }
```

会員登録＆ログイン→店舗一覧→トップページの順で行こうかなとりあえず。  
よし、ブランチ切って始める。

## 会員登録・ログイン

ブランチOK。さっそくsorceryをインストールする。

まずはGemfileに追加してコンテナ内で`bundle install`。  
…と思ったらなんかDockerの調子が悪い。一度PCごと再起動してみるか。

治った。`bundle install`まで済ませたので、`rails g sorcery:install`をする。

よし。今はマイグレーションファイルも特に弄るところ無いのでこのままマイグレーション実行する。

あ、しまったroleを忘れてた。ロールバックして編集してやり直し。

OK。モデルファイルを編集する。バリデーションかけたりenum設定したり。

パスワードのバリデーションの`confirmation: true`ってなんだっけ？  
→sorceryの機能。`password`と`password_confirmation`は実際にはDB上に存在しない仮想属性なのでこういう表記になる。

とりあえず試しにコンソールでユーザーを作成してみる。  
→成功！

次はusersコントローラとusers/new.html.erbを作成する。  
`bin/rails g controller users new`でいいかな。createアクションは手書きする。

よし、まずはコントローラの中身をつくる。Rails基礎編から持ってくるか。

次にビュー。これはこの前作ったサンプルアプリから引っ張ってこよう。

おし。細かいとこは直してないけど一旦表示してみよう。

お、コールバックの`require_login`が無いと言われた。これ自分で書かないといけないんだったっけ。

そもそも`require_login`を`before_action`に設定してなかった。ついでにほかにも色々controllers/application.rbに追加した。

で、今度はルーティングエラー。`users#create`のルーティングを設定してないからだな。`resources`使って書き直す。これでどうだ？

おお〜表示された〜〜！！そしたらフォームをユーザー向けに編集して、フォーム経由で登録できるかテストしよう。

登録できたーー！ログインページまだ作ってないからNameErrorになってるけどデータは登録できた！バリデーションもちゃんときいてる。これで会員登録機能はとりあえずOK。ログイン機能に移る。

まずuser_sessionsコントローラとuser_sessions/new.html.erbを生成する。

できた。次にルーティングの追加。

よし、うまくいくか試す。

おっと、`new_password_reset_path`はコメントアウトしても認識されちゃうのか。ひとまず`#`にしとこう。

というかここまで全然コミットしてなかったことに気づいた！ああ〜しまった〜。ひとまずここでしとこう。

コミットOK。続きに戻る。まだ存在しないヘルパーメソッドを消す。

よーし成功！とりあえず機能だけはできたー！ひとまずコミットしよう。

浮上してきたやりたいこと↓

- ログアウトがちゃんとできるかテストしたい
- フラッシュメッセージが表示されるようにしたい
- そもそも複数の機能を並行して実装していきたい！

やっぱプッシュできないとめんどくさいな〜。まあとにかく今は会員登録＆ログイン周りだけを作っていこう。

今気づいたけどこれdaisyUI反映されてないじゃん！ただのTailWindだ！ええ〜なんで？？

あ、コンテナ立ち上げ直したらちゃんと反映された。そっかたぶんどっかでPCスリープ挟んじゃったからだ。よかった〜。

トップページの作成始めたんだけど、なぜかマージンの指定がきかない〜って苦戦してたら、結局これもコンテナ立ち上げ直し＆`bin/dev`し直しで解決した。別にスリープとかしてないんだけど、なぜかリアルタイムで反映されないという謎現象。地味に困る。  
ともあれこれからはCSSがなんかおかしいと思ったら即コンテナ立ち上げ直し&`bin/dev`し直しする。多分大抵それで直る。というか`bin/dev`し直し（開発用サーバー立ち上げ直し）だけでいいかも。

# 2024.3.3
トップページの続きをやる。昨日作ったロゴをダウンロードして背景透過加工してみよう。それができたら設置。

背景透過全然うまくいかないな…画像サイズ小さすぎるのかな。やっぱり課金するしか無いのか〜。  
とりあえず今はガタガタだけど仮ロゴで試す。

いちおう表示はできた。見た目は後から整えるつもりなので今はこれで。

ん〜〜〜レビュー返ってこないなあ。返ってこないと進められないんだけど…。

アプリ本体はこれ以上進められないので、店舗情報取得の仕組みづくりを先行してやることにする。実験用のディレクトリに移ろう。

まずは最終的にDBに投入したいデータの選定。以下の基本情報は必須。

- 店舗名
- 住所
- 電話番号
- 公式サイトURL
- 営業時間

更にプラスして、本リリース後に必要になる情報も入れておきたい。

ざっと簡単に見た感じ、たぶん緯度経度が必要になる気がするな。つか結構複雑そうでビビる…。  
あとは、後から機種情報加えたくなったときのためになにか紐づけられる情報を…と思ったけど、難しいかもしれないなあ。あるとすれば電話番号とかか。あてになるかなあ。機種検索は諦めることになるかも。

いったんここでどんな情報が取れるか項目全部見てみるか。テストコードでやってみよう。

そうこうしてる間にLGTMきたーー！やった！これで晴れて正式に実装開始だ！  
そしてスケジュール面談なるものを講師とやるらしい。とっとと予約しちゃおう。まずは事前準備だな。

面談予約OK。開発に戻る。

よし、準備できたのでさっそくプッシュする。先に会員登録＆ログインからいくか。

プッシュ＆マージ＆イシュークローズ完了！無事本番環境に反映されるかな？

よっしゃーページはちゃんと表示されてる！あとはバリデーションがちゃんときいてるかと、正しく入力した場合ちゃんと登録されるかだな。

できたーー！ちゃんとユーザー登録できてる！やっぱ課金してよかったわ。本番環境でコンソール使えるのありがたい。バリデーションもちゃんとできてるな。実装成功！  
続けてトップページもいこう。あ、その前にローカルにプルしなきゃ。

もーーーやっぱりアセット周りおかしい！daisyUIが反映されたりされなかったりする謎現象なんなの？？

とりあえずロゴの問題に関しては単に拡張子入れ忘れたのが原因の可能性もあるのでそこを直してデプロイしてみる。  
それとは別にアセット周りの諸々を確認する。そのためのメモを作る。

トップページのロゴ表示されたーーー！よかったあ単に拡張子忘れが原因だった。  
ただそうなるとdaisyUIが不安定な件がますます謎だけど。

## 本日の目標："issueベースの開発"LGTM
達成

## 明日の目標：daisyUIが不安定な原因を見つける

# 2024.3.4
技術面談第２部はもう枠がないかー。夕食＆スケジュール面談後の第３部を狙おう。それに向けて問題をある程度整理しておこうかな。

daisyUIの問題片方解決したーー！ありがとうGPTくん。やっぱり症状を具体的に伝えるのが大事だなと思った。  
結論としては、原因はクラス名を動的に生成していたがために削除対象になってしまっていたこと。  
実はTailwind CSSでは、"tailwind.config.js"内のcontent配列内で指定されたファイルから使用されているCSSクラスを抽出し、それ以外のクラスを最終的なビルドから削除することで、最終的なファイルサイズを減らしている。でも問題のおきたコードはちゃんと抽出対象のファイルに書いていた。なのになぜ削除されてしまったのか？  
理由は、クラス名を変数使って動的に生成していたから。実際のコードは以下の通り。
```erb
<% flash.each do |message_type, message| %>
  <div role="alert" class="alert alert-<%= message_type %>" >
    <%= message %>
  </div>
<% end %>
```
Tailwind CSSのPurge（content）機能は静的解析に基づいていて、ファイル内で動的に生成されるクラス名を適切に識別できない場合があるんだそう。  
そういえばうまく反映されたときは、変数使わずに普通にクラス名ベタ書きしたバージョンのを下にくっつけて2つ一緒に表示したときだった。こんな感じに。
```erb
<% flash.each do |message_type, message| %>
  <div role="alert" class="alert alert-<%= message_type %>" >
    <%= message %>
  </div>

  <!-- 検証のために以下を追加していた -->
  <div role="alert" class="alert alert-error" >
    <%= message %>
  </div>
<% end %>
```
このときはベタ書きしたほうが検出されたから`.alert-error`が削除されずに済んで、結果的に両方ちゃんと適用されたわけだ。（単体のときは`.alert`しか適用されておらず色が反映されてなかった）  

で、どうすればいいのか。  
GPTににきいた対処法のうち個人的にありかなと思ったのは以下2つ。

1. tailwind.config.jsにセーフリストを追加する
2. クラス名を動的に生成するのを避ける

とりあえず採用したのは1。以下のように設定ファイルに記述して、「こいつらは削除対象外ね」と宣言しておく。動的に生成されるクラス名がそんなに多くないならこれで良さそう。
```js
module.exports = {
  content: [
    './app/views/**/*.html.erb',
    './app/helpers/**/*.rb',
    './app/assets/stylesheets/**/*.css',
    './app/javascript/**/*.js'
  ],
  safelist: [
    'alert-error',
    'alert-success',
    'alert-warning',
    // 他の動的に生成されるクラス名もここに追加
  ],
  plugins: [require("daisyui")],
}
```

2は条件分岐などを使うというもの。以下GPTくんが教えてくれた例。
```erb
<% flash.each do |message_type, message| %>
  <div role="alert" class="<%= 'alert ' + (message_type == 'error' ? 'alert-error' : 'alert-success') %>">
    <%= message %>
  </div>
<% end %>
```
これも動的生成ではあるような気がするけど試したら確かにOKだった。文字列と変数の結合がよろしくないのかも？

というわけでTailWind使うときはクラス名の動的生成に気をつけよう！

ふう。この文章書いてたら時間になってしまった。まあ今日は面談も合ったし仕方がないな。整理してアウトプットするのも大事だし。明日は技術面談 + ヘッダー・フッターの実装やるぞ！

## 本日の目標：daisyUIが不安定な原因を見つける
達成

## 明日の目標：ヘッダーの実装

# 2024.3.5
またもや第2部の技術面談枠は埋まってしまったので、3部を狙うことにする。それでもだめなら土日の朝一かな。

さて、今日はヘッダーとフッターを作成する。まずはより簡単なフッターから行こうかな。リンク先だけ"#"にしてあとはだいたい作ってしまおう。

おおむねできたもののトップページだけなんかおかしい！と思ってGPTくんにコード見てもらったら、閉じタグ不備だった…。けどEmmet使えるようにしたからこれからはこういうミス減るはず！  
あとコピーライトの表記はみんなしてるっぽいのでしておくことにする。

よっしフッターできた！次は技術面談の順番待ちしつつヘッダーを作ろう。

ふと思ったんだけどターミナル上でブランチ名に色がつくようにできないのかな。ちゃんと切り替えられてるかぱっと見で判断できると楽なのに…って思った。

中身はまだだけどヘッダー自体は設置完了。ついでにログインとログアウトがちゃんとできることも確認した。

見た目を除けばあとはメニューだけか。ボタン押すとメニューの表示非表示を切り替えられるようにしたいんだよなあ。

技術面談で効果あるかもな記事教えてもらったんだけど、やってみたらおなじみの"genがないよエラー"が出てコンテナ入れなくなってしまった…。もう今日はやめにして明日対処する。まずいじる前の状態に戻ってもう一度丁寧にやり直してみようかな。

### 本日の目標：ヘッダーの実装
達成

### 明日の目標：マイページ・プロフィール編集の実装

# 2024.3.6
昨日の続きから。たぶんだけどこの問題もやっぱりJITが関係してると予想。反映されるのはすでに同じクラスがどこかで使われてるときで、反映されないのは初めて使うクラスのときなんじゃないかと予想。ちゃんと確かめたわけではないけど。つまりビルドの問題。

だめだーー。ビルドの問題だとは思うんだけど解決できない。ここで時間食っててもしょうがないしもう諦めてこのままやってこう。

というわけでマイページの作成に着手。まずは諸々の生成から。  
思ったけどユーザープロフィール今は名前以外いらんかもなあ。それか性別と年代だけレビュー詳細に表示するようにして好きな歌と機種をなしにしとくか。少なくとも今は。

OK。モデルはこんな感じでいいだろう。  
えーとprofilesコントローラに必要なビューはshow、editだけかな。

さて、無事マイページができたので次はプロフィール編集ページを作る。

ん〜`simple_form`使ってみるか？余計に分かりづらくなるかなあ。  
いいやコミットはしてあるしやってみよう。

`simple_form`は余計なクラスとかがいっぱい生成されちゃって駄目だった。どう見てもTailWindとの相性悪い。いちおう`simple_form`とTailWind組み合わせてつかうためのgemもあったけど古いしあんまりメジャーじゃなさそうだったのでやめた。おとなしく普通に`form_with`する。

ロジックはできた！なのであとはもうちょっとだけ見た目をどうにかする。続きは明日ということで。

### 本日の目標：マイページ・プロフィール編集の実装
未達成

### 明日の目標：プロフィール編集の実装を完了

# 2024.3.7
昨日の続き。プロフィール編集ページを終わらせる。

プロフィール編集ページはOK。  
で、ここで次行かずにi18n対応をやっちゃうことにした。今週は目標に対して少し余裕ありそうだし。

ほぼほぼ終わって、あとはコントローラ（というかフラッシュメッセージ）を修正すればおしまい。無理せず明日に持ち越そう。

### 本日の目標：プロフィール編集の実装を完了
達成

### 明日の目標：店舗一覧のたたき台作成

# 2024.3.8
今日は既存のコントローラをi18n対応化することから始める。

i18n対応化完了。ついでにフォームのエラーメッセージをパーシャルに切り出した。

さて、いよいよ店舗一覧にとりかかる。本リリース時のことを考えて、緯度経度のカラムを増やすことにした。それぞれカラム名は"longitude"と"latitude"で。  
ということでブランチ切ってからモデルとテーブルの生成だ。

記事リンクメモ。`decimal`型について。  
https://qiita.com/ayies128/items/031828f76ce10c7f1b51

shopsテーブル作るぞ！ってマイグレーション実行しようとしたら、関連付けする先の`areas`テーブルがないよーってエラーになった。そりゃそうだ。`prefectures`→`areas`→`shops`の順に作らないと駄目だな。

特定のバージョン（マイグレーションファイル）だけマイグレーション実行する方法。  
https://qiita.com/murata0705/items/aa8455f46c8f5db26915

テーブルの作成はOK。次に各モデルにアソシエーションとかバリデーションを追加していく。

`has_many through`は多対多だけでなく1対多の関係でも使える！なんとなくそうなのでは？とは思ってたけど、確かめられてよかった。  
ただし`dependent: :destroy`の使い方には注意！こいつは`has_many through`に付けた場合、`through`に設定したテーブルの対応するレコードを消してしまう。なので挟んでるのが完全な中間テーブル（間をつなぐためだけのテーブル）ならいいけど、今回みたいにそれ自体がエンティティの場合はやっちゃだめ。

### 本日の目標：店舗一覧のたたき台作成
未達成

### 明日の目標：店舗一覧実装完了

# 2024.3.9
今日中に店舗一覧の実装完了を目指す。

URLのバリデーション。  
https://blog.bitarts.jp/entry/2015/09/14/rails_url_validate.html

複数カラムの組み合わせ重複を防ぐバリデーション。  
https://tkmrtech.hateblo.jp/entry/2019/10/20/183010

`latitude`と`longitude`のバリデーションについて。

>decimal(9, 6)というデータ型の場合、全体で9桁の数値を保持でき、そのうち小数点以下は6桁です。これは、緯度や経度のデータを格納するのに一般的に使用される形式です。この場合、小数点以上には最大で3桁（9 - 6 = 3）を保持できます。
>
>Railsのモデルでこのようなバリデーションを設定するには、numericalityのバリデーションをカスタマイズし、独自の検証条件を作成する必要があります。以下は、このバリデーションを設定する一例です：
>
>```ruby
>validates :your_column_name, numericality: { greater_than_or_equal_to: -999.999999, less_than_or_equal_to: 999.999999 }, format: { with: /\A-?\d{1,3}(\.\d{1,6})?\z/ }
>```
>ここで、your_column_nameはバリデーションを適用するカラム名に置き換えてください。このバリデーションは以下のチェックを行います：
>
>numericalityのチェックで、値が数値であること、そして-999.999999から999.999999の範囲にあることを確認します。
>
>formatの正規表現で、数値が最大で小数点以上3桁、小数点以下6桁という形式になっていることを確認します。
>
>このバリデーションにより、指定された形式と範囲の数値のみがデータベースに保存されるようになります。ただし、実際のアプリケーションにおいては、使用する数値の範囲や具体的な要件に応じて、これらのバリデーションを調整する必要があります。また、正規表現は具体的な使用ケースに合わせて調整することができます。この例では、整数部が最大3桁、小数部が最大6桁の数値を受け付けるように設定しています。

モデルは一旦これでOKかな。不都合あったら後から調整しよう。  
次はshopsコントローラの生成。

と思ったけどやらかした。マイグレーションエラーでコンテナ入れなくなった。手動でやる分には自分で順番変えればいいけど、自動で走るマイグレーションはできた順に実行されるもんな。やっぱりひとつのファイルに纏めるかマイグレーションファイル自体を正しい順番になるように作り直すべきだった。  
ここからどうにかするのは余計ややこしくなりそうなので、おとなしくリセットしてやり直す。マイグレーションファイルとモデルのバックアップはとったのでコピペで行ける。よし。

あ〜`rails g model`で一度に複数のモデルとかマイグレーションファイルを生成することはできないんだな。じゃあやっぱり一個ずつ順番にやってくのが確実か。

やり直してみたら`prefectures`テーブルはすでにあるよとのエラー。なんでかと思ったら、DBはアプリを構成してるファイル群（つまりリポジトリ？）とは独立した存在だから、コミットを戻してもロールバックしない限りはもとに戻らないってことみたい。考えてみりゃそりゃそうか。というわけでロールバックする。

色々ごちゃっとしたけどようやくリセットできたっぽい。改めて順番気をつけながらテーブルつくってこう。

issueを分割することにした。テーブル・モデルの作成とそれ以降とで。思ったよりやることが多かった。  
前半は終わってクローズしたので、後半に取り掛かる。

seed_fu、最終更新6年前とかなり古くてびっくりしたけど代替品がなく未だにそこそこよく使われてるっぽいので使うことにする。

seed_fuの使い方。  
https://qiita.com/d0ne1s/items/11d4e51fa11e65653e12

seed_fuでCSVからデータ作成する方法。
https://qiita.com/takaki_k/items/9553faee78a44c83ffb6

よし、Prefectureのシードファイルができた。早速読み込んでみよう。

なぜかまたテーブル重複してるとか言われてごちゃごちゃやった結果、Docker周り全削除（ボリューム含む）でようやく解決。直接的な原因が「コンテナ立ち上げのたびにマイグレーションが実行されていること」なのはわかった。けどなんでというかどこでそう設定されてるのかがまったくわからない。厄介すぎる。

とりあえず先に進む。prefectureのseedファイルが無事投入できるかやってみる。  
あとあれだ。データ全部消えちゃったからあとでユーザー作らなきゃ。先そっちやるか。

ユーザーとプロフィールの作り直し完了。メルアドを`admin@test`に変えたのでそこだけ気をつけよう。  
いざPrefecture。

成功。続いてarea。

こちらも成功。最後に肝心のshop！

よし！データ入った！

ここからは普通にコントローラとビュー作成・ルーティング追加。

ビューの出来はひどいけどとりあえず店舗一覧完成！続いて店舗詳細に移る。  
店舗詳細ができたら今週の目標達成なので、一旦Backlogに積んである雑タスクをどれかやる。早めにやっといたほうが良さそうなのはLintチェックとかprettierかな。あとカスタムテーマもモチベーション上がりそう＆完成イメージ湧きやすくなりそう。

ビューを作る。これも仮だけど。

戻るボタンについて。
https://qiita.com/nekojoker/items/cb662de7cbb65e438985

本番環境にも無事仮のダミーデータを投入！よかった〜ちゃんとできて。

よし、無事今週の目標達成できたので雑タスクに手を付ける。Lintチェックからいこうかな。Rubocopの使い方調べよう。

Rubocopは無事導入完了。そしてPrettierはerbで使うのがちょっと面倒そうなので諦めてアンインストールした。代わりに`eslint`なるツールでできるかもしれないんだけど、それはまた余裕があったら考えることにする。

う〜んどうしよう、ここでカスタムテーマいっちゃうか？やり方だけみとくか。

# 2024.3.10
昨日はあのまま寝てしまった。目標ここに書くの忘れちゃったけどまあどうせ今日の終わりに書くからいいか。

今日はまずカスタムテーマからいっちゃう！今の殺風景な見た目だとやる気出づらいし、配色のイメージもつきづらい。

テーマ適用はできたんだけど、なんかローカルホストでファイルの変更が反映されなくなってしまったんだが。昨日まで普通だったのになんで？？一回ボリューム削除してビルドし直したからか？？  
全く原因がわからんので、とりあえずPCごと再起動してみることにする。

原因判明。書き換えてるのログイン前のヘッダーなのにブラウザはログイン後だった…。見てるファイルと書いてるファイルが違ったというオチ。アホか！

ともあれ変な不具合じゃなくてよかった。レビュー投稿にとりかかる。  
今回はちゃんと事前にER図を確認。reviewsが依存してるのはusersとshopsだけなので、このまま単体でテーブル作成して問題なし。よしやるぞ。

テーブルとモデルはたぶんOK。次はコントローラとビューを作成する。

おーーしようやく投稿のロジックができた！評価なしの場合にどうするかはまた考えることにする。まあ「星0 = 評価なし」ですよって注意書きするのが一番簡単で現実的かな。MVPリリース時点ではそれでいいや。  
あとはロケールの追加と各種リンクの有効化だ。

できた。次、レビュー一覧いく。

ん〜〜なんか混乱してきた。とりあえず仕組みはできてるはずなので明日はデータを増やして確認するところから始める。その後は星をどう表示するか考える。冷静に考えるとちょいめんどいかも。

### 本日の目標：レビュー投稿実装完了
達成

### 明日の目標：レーティングの表示方法を考える

# 2024.3.11
今日はまずレビュー一覧が正しく動作してるかの確認から。

OK。ちゃんと表示されてる。  
あとは個々のレビューにレビューするボタンが表示されないようにして、代わりにページの頭にそのボタンを表示するようにしよう。本当はヘッダーの下にコラプスメニューとしてくっつけたいけど、今はとりあえず普通に表示で。

よし。レイアウト的には全然ヨシじゃないけどとりあえずヨシ。  
ここからは今日の本題、レーティングの星をどうやって表示するか考えていく。

開発者ツールで覗いた結果、星はやっぱりsvg形式だった。以下情報。
`url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='192' height='180'%3E%3Cpath fill-rule='evenodd' d='m96 153.044-58.779 26.243 7.02-63.513L.894 68.481l63.117-13.01L96 0l31.989 55.472 63.117 13.01-43.347 47.292 7.02 63.513z'/%3E%3C/svg%3E")`

やりかた見つけた！モデルに紐づかない単なるラジオボタン（非有効化、カーソルをデフォルトに）にすればフォームで使うときとほぼ同じようにできる！  
`radio_button_tag`っていうヘルパーメソッドが使える。

ほぼほぼできたんだけど、なぜか一番最初のレビューだけ全部星5つになってる。全く同じパーシャルを使ってるんだけどなんで？？そんなことある？？

### 本日の目標：レーティングの表示方法を考える
微妙。方法は見つけられたけど一部表示がおかしい。

### 明日の目標：レビュー一覧実装完了

# 2024.3.12
星の表示おかしい問題をどうにか解決してレビュー一覧を今日で終わりたい。

自己解決！`<input>`タグの`id`や`name`属性が異なるレコード間で同一になっちゃってたことが原因ぽい。おそらくだけどレコード1の`minimal_interaction`とレコード2の`minimal_interaction`が、全く同じ名前になってたがために両方合わせて一つのレーティング項目としてみなされてた（つまり星10だと認識されてた）んじゃないかと推測。で、一番最後の`checked="checked"`（レコード2のほう）が実際のチェック判定になって、「そこまでは全部色付きの星」になっちゃってたんじゃないかな。  
とにかくよかった！あとはレビューするボタンの下にマージンだけ付けてレビュー一覧はクローズしちゃおう。

長い文字列を省略して表示する方法。  
https://qiita.com/ishidamakot/items/2e74d980b3a338e4c784

よし！レビュー一覧とりあえずOK。ついでにレビュー投稿ボタンの表示切替も実装した。  
次はレビュー詳細。今日はここまでにして明日やろう。

### 本日の目標：レビュー一覧実装完了
達成

### 明日の目標：レビュー詳細・レビュー編集実装完了

# 2023.3.13
今日はレビュー詳細から。まずブランチ切る。

よっっし！いい感じにできた！次はレビュー編集と削除。

う〜〜ん。ボタンの表示テキスト切替、条件分岐でやるしか無いのか？？  
明日また考えよう。

### 本日の目標：レビュー詳細・レビュー編集実装完了
未達成。レビュー詳細だけできた。

### 明日の目標：レビュー編集実装完了

# 2024.3.14
ボタンの表示切替の続き。たぶん条件分岐するしかなさそう。

ボタンはヨシ。自分以外のユーザーが作成したレビューの編集画面にURL直打ちで飛べないようにするのってどうやるんだっけ…。

解決。オブジェクトをセットするときに、`@object = Object.find(params[:id])`じゃなくて`@object = current_user.objects.find(params[:id])`にすることで、ログイン中のユーザーが作成したオブジェクトのみを検索対象にするんだ。それなら自分以外のユーザーが作成したオブジェクトをいじろうとしても「見つからなかったよ！」っていうエラーになる。  
そのエラーにも専用のページを用意するほうが親切というかきれいだけど、MVPリリースでそこまではいらんやろ。

shallowオプションを使ったネストリソースルーティングの場合、`form_with`のモデルの指定が若干面倒という学びを得た。紐づけるモデルを単独か複合かわけないといけない。

レコードが保存住処確認するメソッド。  
https://kemarii.com/blog/rails/method-presisted/

いちおうできたけど、なんかスマートじゃない気がして気持ち悪い。GPTくんにリファクタリングお願いしてみるか。

レーティング項目のところがパーシャルとして切り出すと良さそう、他はいい感じだと思う、とのこと。切り出すか。  
あとさっきたまたま知ったけど、`collection_radio_buttons`っていうフォームヘルパーがあるんだな。`each`よりこっち使ったほうがスマートかも？  
…と思ったけど、今回の場合は全部の項目使うわけじゃないからやりづらいな。いいや、パーシャルへの切り出しだけしよう。

よし、切り出しはうまく行った。  
編集＆削除ボタンも同じくパーシャル化しちゃおう。

`send`メソッドというものを知った。これは便利！  
https://qiita.com/ngron/items/05d3a9624c2c3ec5dbb6

ボタンを右寄せにする方法がよ〜〜〜やくわかった。daisyUIのボタンは`inline-flex`要素になっているので、以下のいずれかで対処する。基本は2のほうが管理しやすいかな。
1. 親要素に`text-right`
2. 親要素に`w-full`（あるいは任意の横幅指定）と`flex`と`justify-end`

横幅を指定してやるのがポイントだな。詳しい理屈は理解できてないけど、これがないと親要素（`<div>`）の幅が子要素の分だけになっちゃって右寄せにならない。

よし、レビューの編集＆削除機能実装完了！細かいところが気になって思いの外時間かかっちゃったけど、まあどうせいつかはやらなきゃいけないことだったし先取りしたと思おう。

### 本日の目標：レビュー編集実装完了
達成

### 明日の目標：マイレビュー一覧実装完了

# 2024.3.15
今日はまずバグ修正から。自分以外のプロフィールやレビューを編集・削除できないようにする。

と思ったらすでに直してあった。なのでこのままマイレビュー一覧に取り掛かる。

よし、マイレビュー一覧できた！次はタグに取りかかる。今までやってきた感じからいくと、これはけっこう手間取るかも。ストーリーポイントを5に変更する。

さてこれはまたマイグレーションの順番をちゃんと考えないとだ。ER図みて順番決めてから作り始めよう。  
まずは何にも依存してない`tags`。その後は`review_tags`でも`shop_tags`でもどっちからでもOKって感じかな。  
というか今回はまとめて3つ一気に作ってみるか。

よし、3つまとめてマイグレーション成功。次はモデルを作る。

テーブルとモデルOK。次はコントローラ。

作ってからふと思ったけどこれひょっとしてコントローラいらんのでは？  
…ぱっとわからないからとりあえずこのまま進もう。その結果いらないということが判明したら消せば良い。

さてここからが問題だ。`form_with`のオプションに指定したのとは別のモデルに紐づいた項目をどう送信してどう処理するか考えないと。考えてなかった。まずはRailsガイドでも読んでみるか。

`fields_for`メソッドが使えるのかな？もうちょい調べてみる。

使えそうだ。この記事がやりたいことにかなり近そう。  
https://sakurai-chan.hatenablog.com/entry/2018/10/09/234139

今日はここまで。明日さっきの記事を詳しく見て、ある程度方向性がつかめたらまずタグをいくつかseed_fuで作って、それから実験しよう。

### 本日の目標：マイレビュー一覧実装完了
達成

### 明日の目標：タグ機能のロジック完成

# 2024.3.16
タグ昨日のロジックを考えていく。まずは昨日の記事を読む。

なるほど。私のアプリで言うと、
- Reviewモデルに`accepts_nested_attributes_for :review_tags`を追加
- reviewsコントローラのnewアクションに`@review.tags.build`を追加
- reviewsコントローラの`review_params`に`review_tags_attributes: [:tag_id]`を追加
- フォームのビューに`form.fields_for`を追加

って感じかな。  
問題は`shop_tag`をどうするか、か。reviewsコントローラのアクションの中で一緒に生成（必要なら）する感じかな。userとprofileみたいに。  
まあとにかくやってみるか。

決めた。タグはレビューとは紐づけないことにする。単純にshopとだけ紐づけて、会員ならだれでも付け外しできるようにする。だれがどのタグを付けたか外したかとかいらないし。  
そうとなれば`review_tags`テーブル、モデル、コントローラは削除だな。一度DBをロールバックしよう。

さて、まずは店舗の一覧や詳細にタグをどう表示するか考えなくちゃ。  
daisyUIのBadgeを使うか。

よし、見た目のあたりは大体ついた。次はダミーデータを用意して表示してみよう。

表示もOK！あとは編集＆削除だな。まずビューから行ったほうがわかりやすいかな。

ルーティングでちょっと混乱したけどいけたっぽい。URLを書き換える方法↓  
https://qiita.com/supercell1023koeda/items/ab01bd58392ade02f50f

よし！Ajax化はまだだけどとりあえずできた。  
tagsコントローラはやっぱり今のところいらなそうなので一旦消す。

本番環境用のダミーデータを忘れてた。作成して入れる。

本番環境でも動作確認OK！

タグボタンのAjax化も完了。  
`turbo_stream`用のビューは`アクション名.turbo_stream.erb`。**末尾が`html.erb`ではなく単に`.erb`なので要注意！**

次は店舗詳細にレビュー抜粋を表示する。どんな見た目にするか作りながら考えよう。

### 本日の目標：タグ機能のロジック完成
達成

### 明日の目標：店舗詳細に最新レビュー５件を表示

# 2024.3.17
ブランチは切ってあるので早速ビューを編集していく。

コマンドの違いについて。  
https://prograshi.com/framework/rails/difference-rake-rails-bin-bundle_exec/

とりあえずできてデプロイもしたんだけど、"最新5件のみを表示"ができてるか確認するためにseed_fuのファイルを追加＆整理した。  
で、これを本番環境に適用するにあたり一度DBをリセットしようと思う。必ずしもこのタイミングで必要ではないかもなんだけど、うっかり既存のデータとかち合って変なことになるのを避けたいというのと、最終的にMVPリリースするときには余計なダミーデータがない状態にしなきゃいけないわけで、つまりいつかはやることになるから今のうちに一回経験しときたいという理由。  
というわけでレッツチャレンジ。変なことにならないのを祈る。

本番環境でのDBリセットの仕方。railsサーバーを停止させてる記事とさせてない記事があってどっちにするか迷う…。  
https://ryo10leo.hatenablog.com/entry/2020/01/23/022451  
https://zenn.dev/aosan/scraps/c2620894b9b356

とりあえず停止させずにやってみよう。あとタイポが怖いからここにコマンドメモ作ってコピペしよう。  
環境変数指定してるところはたぶんいらない気がするけど、あるとまずいってことはたぶんないだろうからこのまま行く。

↓でDBごと消去
```shell
RAILS_ENV=production DISABLE_DATABASE_ENVIRONMENT_CHECK=1 bundle exec rails db:drop
```

↓でDBを新たに作成
```shell
bundle exec rails db:create RAILS_ENV=production
```

↓でマイグレーションを実行
```shell
bundle exec rails db:migrate RAILS_ENV=production
```

↓でseed_fuのファイルを反映
```shell
bundle exec rails db:seed_fu RAILS_ENV=production
```

できたーーーーー！！一瞬繋がらなくなって焦ったけどできたーーーー！！良かったあああ安心した…。  
あとはレビューがない場合の表示だけ修正してissue閉じよう。

今週の目標は達成したので、細々したことを片付ける。まずはユーザー登録とログインのフォームをdaisyUIのコンポーネントで置き換える。

フォームの置き換えができたからログイン後のヘッダーにユーザー名表示するのを始めたんだけど、ついでにログイン前のヘッダーも少しだけいじろうかなと思ってログアウトしたらログインできなくなった。  
なんでかと思ったら、まさかの`crypted_password`と`salt`が生成されてなかった。どうやらseed_fuでユーザーデータを投入した場合はsorceryの自動生成がきかないらしい。  
どうすればいいのかと思って調べたら、`seed`メソッドじゃなく`create`（および`create!`メソッド）でやれば生成されるということが判明。ただ、seed_fuでは`create`はできても`create!`はできないようだったので、userおよびuserとセットのprofileのみ通常のseedで投入することにした。
というわけで、今後データベースの作り直しをするときは、一度まっさらにした後、`bin/rails db:seed`をやってから`bin/rails db:seed_fu`を実行する必要がある。  
今日は本番環境のDBリセットまでいかなかったので、明日はそこからやる。seedファイル自体は準備できてるので、コマンド叩くだけでいけるはず。

seed関係参考記事。  
https://qiita.com/TatsuyaIsamu/items/2e01a9a8d127f83c2161

### 本日の目標：店舗詳細に最新レビュー５件を表示
達成

### 明日の目標：レビューボタンのバグ修正、検索機能用のダミーデータ作成完了
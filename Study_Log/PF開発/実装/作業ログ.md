# 2024.3.2

まずはヘッダーとフッターから行くか。  
今は触らないでおくけど、あとでIssueをIn Progressに移動させるのを忘れないようにしよう。あとプルリク時にIssueにリンクさせるのも。

最初にとにかくブランチを切る！これを忘れないように気をつけなきゃ。

ブランチの命名とか切り分けどうしようと思って色々見てみた。  
main→develop→個々のブランチ、みたいに2回枝分かれするやり方もあるみたいだけど、正直絶対混乱してやらかすと思うからdevelopはなしでいく。mainから直接個々のブランチに枝分かれする方式で。  
で、命名については"`featureとか/個々のブランチ名_#issueナンバー`"でいこう。

あとやっぱり最初は会員登録・ログインから行こうかな。そこと店舗一覧ができてからトップページに移行する。ヘッダー・フッターはもう少し後でいいや。  
というか会員登録とログイン分けたほうが良かったかも。

んん〜〜どうしよう。そのへんのこともあるし、やっぱりレビュー返って来るまで進めないほうがいいか？先にロゴとか作る？

とりあえず仮にロゴ作るか…。

仮ロゴできた。  
まだレビューこないなあ。次はdaisyUIの配色（テーマ）でも作るか？

仮テーマ作ったのでメモっとく。

```js
module.exports = {
    daisyui: {
      themes: [
        {
          mytheme: {
 "primary": "#3F6C45",
 "secondary": "#50312F",
 "accent": "#CB0000",
 "neutral": "#fef9c3",
 "base-100": "#E4EA8C",
 "info": "#2dd4bf",
 "success": "#22c55e",
 "warning": "#fbbf24",
 "error": "#f43f5e",
          },
        },
      ],
    },
    plugins: [
      require('daisyui'),
    ],
    //...
  }
```

会員登録＆ログイン→店舗一覧→トップページの順で行こうかなとりあえず。  
よし、ブランチ切って始める。

## 会員登録・ログイン

ブランチOK。さっそくsorceryをインストールする。

まずはGemfileに追加してコンテナ内で`bundle install`。  
…と思ったらなんかDockerの調子が悪い。一度PCごと再起動してみるか。

治った。`bundle install`まで済ませたので、`rails g sorcery:install`をする。

よし。今はマイグレーションファイルも特に弄るところ無いのでこのままマイグレーション実行する。

あ、しまったroleを忘れてた。ロールバックして編集してやり直し。

OK。モデルファイルを編集する。バリデーションかけたりenum設定したり。

パスワードのバリデーションの`confirmation: true`ってなんだっけ？  
→sorceryの機能。`password`と`password_confirmation`は実際にはDB上に存在しない仮想属性なのでこういう表記になる。

とりあえず試しにコンソールでユーザーを作成してみる。  
→成功！

次はusersコントローラとusers/new.html.erbを作成する。  
`bin/rails g controller users new`でいいかな。createアクションは手書きする。

よし、まずはコントローラの中身をつくる。Rails基礎編から持ってくるか。

次にビュー。これはこの前作ったサンプルアプリから引っ張ってこよう。

おし。細かいとこは直してないけど一旦表示してみよう。

お、コールバックの`require_login`が無いと言われた。これ自分で書かないといけないんだったっけ。

そもそも`require_login`を`before_action`に設定してなかった。ついでにほかにも色々controllers/application.rbに追加した。

で、今度はルーティングエラー。`users#create`のルーティングを設定してないからだな。`resources`使って書き直す。これでどうだ？

おお〜表示された〜〜！！そしたらフォームをユーザー向けに編集して、フォーム経由で登録できるかテストしよう。

登録できたーー！ログインページまだ作ってないからNameErrorになってるけどデータは登録できた！バリデーションもちゃんときいてる。これで会員登録機能はとりあえずOK。ログイン機能に移る。

まずuser_sessionsコントローラとuser_sessions/new.html.erbを生成する。

できた。次にルーティングの追加。

よし、うまくいくか試す。

おっと、`new_password_reset_path`はコメントアウトしても認識されちゃうのか。ひとまず`#`にしとこう。

というかここまで全然コミットしてなかったことに気づいた！ああ〜しまった〜。ひとまずここでしとこう。

コミットOK。続きに戻る。まだ存在しないヘルパーメソッドを消す。

よーし成功！とりあえず機能だけはできたー！ひとまずコミットしよう。

浮上してきたやりたいこと↓

- ログアウトがちゃんとできるかテストしたい
- フラッシュメッセージが表示されるようにしたい
- そもそも複数の機能を並行して実装していきたい！

やっぱプッシュできないとめんどくさいな〜。まあとにかく今は会員登録＆ログイン周りだけを作っていこう。

今気づいたけどこれdaisyUI反映されてないじゃん！ただのTailWindだ！ええ〜なんで？？

あ、コンテナ立ち上げ直したらちゃんと反映された。そっかたぶんどっかでPCスリープ挟んじゃったからだ。よかった〜。

トップページの作成始めたんだけど、なぜかマージンの指定がきかない〜って苦戦してたら、結局これもコンテナ立ち上げ直し＆`bin/dev`し直しで解決した。別にスリープとかしてないんだけど、なぜかリアルタイムで反映されないという謎現象。地味に困る。  
ともあれこれからはCSSがなんかおかしいと思ったら即コンテナ立ち上げ直し&`bin/dev`し直しする。多分大抵それで直る。というか`bin/dev`し直し（開発用サーバー立ち上げ直し）だけでいいかも。

# 2024.3.3
トップページの続きをやる。昨日作ったロゴをダウンロードして背景透過加工してみよう。それができたら設置。

背景透過全然うまくいかないな…画像サイズ小さすぎるのかな。やっぱり課金するしか無いのか〜。  
とりあえず今はガタガタだけど仮ロゴで試す。

いちおう表示はできた。見た目は後から整えるつもりなので今はこれで。

ん〜〜〜レビュー返ってこないなあ。返ってこないと進められないんだけど…。

アプリ本体はこれ以上進められないので、店舗情報取得の仕組みづくりを先行してやることにする。実験用のディレクトリに移ろう。

まずは最終的にDBに投入したいデータの選定。以下の基本情報は必須。

- 店舗名
- 住所
- 電話番号
- 公式サイトURL
- 営業時間

更にプラスして、本リリース後に必要になる情報も入れておきたい。

ざっと簡単に見た感じ、たぶん緯度経度が必要になる気がするな。つか結構複雑そうでビビる…。  
あとは、後から機種情報加えたくなったときのためになにか紐づけられる情報を…と思ったけど、難しいかもしれないなあ。あるとすれば電話番号とかか。あてになるかなあ。機種検索は諦めることになるかも。

いったんここでどんな情報が取れるか項目全部見てみるか。テストコードでやってみよう。

そうこうしてる間にLGTMきたーー！やった！これで晴れて正式に実装開始だ！  
そしてスケジュール面談なるものを講師とやるらしい。とっとと予約しちゃおう。まずは事前準備だな。

面談予約OK。開発に戻る。

よし、準備できたのでさっそくプッシュする。先に会員登録＆ログインからいくか。

プッシュ＆マージ＆イシュークローズ完了！無事本番環境に反映されるかな？

よっしゃーページはちゃんと表示されてる！あとはバリデーションがちゃんときいてるかと、正しく入力した場合ちゃんと登録されるかだな。

できたーー！ちゃんとユーザー登録できてる！やっぱ課金してよかったわ。本番環境でコンソール使えるのありがたい。バリデーションもちゃんとできてるな。実装成功！  
続けてトップページもいこう。あ、その前にローカルにプルしなきゃ。

もーーーやっぱりアセット周りおかしい！daisyUIが反映されたりされなかったりする謎現象なんなの？？

とりあえずロゴの問題に関しては単に拡張子入れ忘れたのが原因の可能性もあるのでそこを直してデプロイしてみる。  
それとは別にアセット周りの諸々を確認する。そのためのメモを作る。

トップページのロゴ表示されたーーー！よかったあ単に拡張子忘れが原因だった。  
ただそうなるとdaisyUIが不安定な件がますます謎だけど。

## 本日の目標："issueベースの開発"LGTM
達成

## 明日の目標：daisyUIが不安定な原因を見つける

# 2024.3.4
技術面談第２部はもう枠がないかー。夕食＆スケジュール面談後の第３部を狙おう。それに向けて問題をある程度整理しておこうかな。

daisyUIの問題片方解決したーー！ありがとうGPTくん。やっぱり症状を具体的に伝えるのが大事だなと思った。  
結論としては、原因はクラス名を動的に生成していたがために削除対象になってしまっていたこと。  
実はTailwind CSSでは、"tailwind.config.js"内のcontent配列内で指定されたファイルから使用されているCSSクラスを抽出し、それ以外のクラスを最終的なビルドから削除することで、最終的なファイルサイズを減らしている。でも問題のおきたコードはちゃんと抽出対象のファイルに書いていた。なのになぜ削除されてしまったのか？  
理由は、クラス名を変数使って動的に生成していたから。実際のコードは以下の通り。
```erb
<% flash.each do |message_type, message| %>
  <div role="alert" class="alert alert-<%= message_type %>" >
    <%= message %>
  </div>
<% end %>
```
Tailwind CSSのPurge（content）機能は静的解析に基づいていて、ファイル内で動的に生成されるクラス名を適切に識別できない場合があるんだそう。  
そういえばうまく反映されたときは、変数使わずに普通にクラス名ベタ書きしたバージョンのを下にくっつけて2つ一緒に表示したときだった。こんな感じに。
```erb
<% flash.each do |message_type, message| %>
  <div role="alert" class="alert alert-<%= message_type %>" >
    <%= message %>
  </div>

  <!-- 検証のために以下を追加していた -->
  <div role="alert" class="alert alert-error" >
    <%= message %>
  </div>
<% end %>
```
このときはベタ書きしたほうが検出されたから`.alert-error`が削除されずに済んで、結果的に両方ちゃんと適用されたわけだ。（単体のときは`.alert`しか適用されておらず色が反映されてなかった）  

で、どうすればいいのか。  
GPTににきいた対処法のうち個人的にありかなと思ったのは以下2つ。

1. tailwind.config.jsにセーフリストを追加する
2. クラス名を動的に生成するのを避ける

とりあえず採用したのは1。以下のように設定ファイルに記述して、「こいつらは削除対象外ね」と宣言しておく。動的に生成されるクラス名がそんなに多くないならこれで良さそう。
```js
module.exports = {
  content: [
    './app/views/**/*.html.erb',
    './app/helpers/**/*.rb',
    './app/assets/stylesheets/**/*.css',
    './app/javascript/**/*.js'
  ],
  safelist: [
    'alert-error',
    'alert-success',
    'alert-warning',
    // 他の動的に生成されるクラス名もここに追加
  ],
  plugins: [require("daisyui")],
}
```

2は条件分岐などを使うというもの。以下GPTくんが教えてくれた例。
```erb
<% flash.each do |message_type, message| %>
  <div role="alert" class="<%= 'alert ' + (message_type == 'error' ? 'alert-error' : 'alert-success') %>">
    <%= message %>
  </div>
<% end %>
```
これも動的生成ではあるような気がするけど試したら確かにOKだった。文字列と変数の結合がよろしくないのかも？

というわけでTailWind使うときはクラス名の動的生成に気をつけよう！

ふう。この文章書いてたら時間になってしまった。まあ今日は面談も合ったし仕方がないな。整理してアウトプットするのも大事だし。明日は技術面談 + ヘッダー・フッターの実装やるぞ！

## 本日の目標：daisyUIが不安定な原因を見つける
達成

## 明日の目標：ヘッダーの実装

# 2024.3.5
またもや第2部の技術面談枠は埋まってしまったので、3部を狙うことにする。それでもだめなら土日の朝一かな。

さて、今日はヘッダーとフッターを作成する。まずはより簡単なフッターから行こうかな。リンク先だけ"#"にしてあとはだいたい作ってしまおう。

おおむねできたもののトップページだけなんかおかしい！と思ってGPTくんにコード見てもらったら、閉じタグ不備だった…。けどEmmet使えるようにしたからこれからはこういうミス減るはず！  
あとコピーライトの表記はみんなしてるっぽいのでしておくことにする。

よっしフッターできた！次は技術面談の順番待ちしつつヘッダーを作ろう。

ふと思ったんだけどターミナル上でブランチ名に色がつくようにできないのかな。ちゃんと切り替えられてるかぱっと見で判断できると楽なのに…って思った。

中身はまだだけどヘッダー自体は設置完了。ついでにログインとログアウトがちゃんとできることも確認した。

見た目を除けばあとはメニューだけか。ボタン押すとメニューの表示非表示を切り替えられるようにしたいんだよなあ。

技術面談で効果あるかもな記事教えてもらったんだけど、やってみたらおなじみの"genがないよエラー"が出てコンテナ入れなくなってしまった…。もう今日はやめにして明日対処する。まずいじる前の状態に戻ってもう一度丁寧にやり直してみようかな。

### 本日の目標：ヘッダーの実装
達成

### 明日の目標：マイページ・プロフィール編集の実装

# 2024.3.6
昨日の続きから。たぶんだけどこの問題もやっぱりJITが関係してると予想。反映されるのはすでに同じクラスがどこかで使われてるときで、反映されないのは初めて使うクラスのときなんじゃないかと予想。ちゃんと確かめたわけではないけど。つまりビルドの問題。

だめだーー。ビルドの問題だとは思うんだけど解決できない。ここで時間食っててもしょうがないしもう諦めてこのままやってこう。

というわけでマイページの作成に着手。まずは諸々の生成から。  
思ったけどユーザープロフィール今は名前以外いらんかもなあ。それか性別と年代だけレビュー詳細に表示するようにして好きな歌と機種をなしにしとくか。少なくとも今は。

OK。モデルはこんな感じでいいだろう。  
えーとprofilesコントローラに必要なビューはshow、editだけかな。

さて、無事マイページができたので次はプロフィール編集ページを作る。

ん〜`simple_form`使ってみるか？余計に分かりづらくなるかなあ。  
いいやコミットはしてあるしやってみよう。

`simple_form`は余計なクラスとかがいっぱい生成されちゃって駄目だった。どう見てもTailWindとの相性悪い。いちおう`simple_form`とTailWind組み合わせてつかうためのgemもあったけど古いしあんまりメジャーじゃなさそうだったのでやめた。おとなしく普通に`form_with`する。

ロジックはできた！なのであとはもうちょっとだけ見た目をどうにかする。続きは明日ということで。

### 本日の目標：マイページ・プロフィール編集の実装
未達成

### 明日の目標：プロフィール編集の実装を完了
# 2023.11.24
ようやく前回の課題に関するまとめが終わったので次の課題に移る。  
まずはブランチを切って課題の概要を把握。

把握。要件そのものはシンプルで、以下の要素による検索機能（下書き記事含む）を追加せよとのこと。
- 著者（セレクトボックス）
- タグ（セレクトボックス）
- 記事内容（フリーワード）

とりあえずすでに実装済みの検索機能を確認する。
位置としては`admin/articles/index.html.slim`の12行目からだな。
中身を読む。

ransackは使ってないっぽいな。`SearchArticlesForm`っていうクラスを用意して、そこにフォームデータを送信してる。
`SearchArticlesForm`は`app/forms`ディレクトリの中。
`ActiveModel::Model`と`ActiveModel::Attributes`を`include`してる。疑似モデルってとこかな？

一旦コードの意味をロボらんてくんに解説してもらおう。
その前にバージョンメモ。
- Railsのバージョン：7.0.4
- Rubyのバージョン：3.1.4

以下回答。
>このコードは、記事を検索するためのフォームオブジェクトを定義しているよ。1行ずつ解説するね。
>
>```rb
>class SearchArticlesForm
>```
>SearchArticlesFormという名前のクラスを定義している。クラス名からこのクラスが記事を検索するフォームの機能を持つことが予想される。
>```rb
>  include ActiveModel::Model
>```
>Active Modelのモジュールをインクルードしていて、これによってRailsのモデルと似たような機能（バリデーションなど）をこのクラスに追加している。
>```rb
>  include ActiveModel::Attributes
>```
>Active ModelのAttributesモジュールをインクルードしており、属性の型を定義できるようになっている。
>```rb
>  attribute :category_id, :integer
>```
>category_idという整数型の属性を定義している。これは記事のカテゴリーを指定するために使われる。
>```rb
>  attribute :title, :string
>```
>titleという文字列型の属性を定義していて、これは検索する記事のタイトルを指定するために使われる。
>```rb
>  def search
>```
>searchというインスタンスメソッドを定義している。このメソッドは検索処理を実行する。
>```rb
>    relation = Article.distinct
>```
>Articleモデルの全てのレコードを取得し、重複を排除した状態のクエリオブジェクトを変数relationに代入している。
>```rb
>    relation = relation.by_category(category_id) if category_id.present?
>```
>category_idが存在する場合（nilや空でない場合）、by_categoryスコープを使って、そのカテゴリーIDに基づく記事を絞り込んでいる。
>```rb
>    title_words.each do |word|
>```
>title_wordsメソッドで得られたタイトルの各単語に対してループ処理を開始している。
>```rb
>      relation = relation.title_contain(word)
>```
>title_containスコープを使って、各単語が含まれる記事で絞り込みを行っている。ここでrelationはさらに絞り込まれていく。
>```rb
>    end
>```
>各単語に対するループ処理が終了する。
>```rb
>    relation
>```
>最終的に絞り込まれた記事のクエリオブジェクトをメソッドの戻り値として返している。
>```rb
>  end
>```
>searchメソッドの定義が終わっている。
>```rb
>  private
>```
>以下のメソッドはこのクラスの外部からは呼び出せないプライベートメソッドであることを示している。
>```rb
>  def title_words
>```
>title_wordsというプライベートメソッドを定義している。これはタイトルを単語に分割するためのメソッドだ。
>```rb
>    title.present? ? title.split(nil) : []
>```
>タイトル(title)が存在する場合はそのタイトルを空白文字で分割して単語の配列にし、存在しない場合は空の配列を返している。
>```rb
> end
>```
>title_wordsメソッドの定義が終わっている。
>```rb
>end
>```
>SearchArticlesFormクラスの定義が終わっている。
>このクラスは、指定されたカテゴリーとタイトルの単語を含む記事を検索するために使われるんだ。

ちなみに`distinct`メソッドはレコードの重複を除くというもの。なぜこの場合に必要なのかは今のところわからず。  
あと`by_category`とか`title_contain`は何者？と思ってたけどscopeだということが判明。たしかにメソッド以外にそういう可能性もあったな。覚えておこう。

大まかな実装方針としては
- `attribute`を追加
- scopeを追加
- 絞り込みロジックを`search`アクションに追加
- ビューにフォームを追加

って感じかな。
まず`attribute`の追加から着手するか。

必要な`attribute`は
- author_id(integer)
- tag_id(integer)
- body(string)

かな…？記事内容がちょっと自信ないというかまだよくわかってない。あくまで文章ブロックのみ対象でいいのか？  
一旦そこは保留にして追加する。

OK。次にscopeの追加。

OK。次は絞り込みロジックの追加。既存のを参考にやってみよう。

よし。ここまではOK。次にフォームの追加。

セレクトボックスの作り方。[参考記事](https://310nae.com/rails-selectbox/)
```erb
<%= f.select( プロパティ名, 選択肢, {オプション}, {HTMLオプション} ) %>
```
プロパティ名は送信する際のパラメータ名。通常はカラム（属性）名にすることが多い。なおHTMLオプションを使う場合は、無印オプションを省略できない。かならず空の大かっこを入れること。

`index.rb`見てて思ったんだけど、`=>`って何？どういう書き方？Slimの記法調べても出てこないんだけど…。ロボらんてくんに訊いてみるか。

ロボらんてくんにもしらんて言われた…。正確には「タイプミスじゃないかな」だけど。いいや一旦ほっとこう。

`pluck`について調べてたら`distinct`が必要な理由がわかった。これは`distinct`を呼び出した時点で重複を取り除くんじゃなくて、発行されるSQL文が`SELECT DISTINCT ...`になるっていう意味なんだたぶん。だから`モデル.distinct`としておいて、その後にどんなクエリが来てもレコードが重複しないようにしてるんだ。それこそ`pluck`は返り値が配列になるからメソッドチェーンの最後に持ってこなきゃいけないし。なるほどなあ。

よし、著者とタグのセレクトボックスはできた。次は記事内容のフォームだな。作るだけ作って、それから”記事内容”が実際には何を指すのか確かめよう。
今日はここまで。


